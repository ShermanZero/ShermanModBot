"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("colors");
const fs = require("fs");
const path = require("path");
const rimraf = require("rimraf");
const ranks_1 = require("../resources/ranks");
const user_config_1 = require("../resources/user_config");
class Resources {
    static getUsernameFromMessage(message) {
        let username;
        if (message.member)
            username = message.member.user.tag.replace("#", "_");
        else
            return null;
        username = username.replace(/[^\w\s]/gi, "").toLowerCase();
        return username;
    }
    static getUsernameFromMember(member) {
        let username = member.user ? member.user.tag : member.tag;
        username = username
            .replace("#", "_")
            .replace(/[^\w\s]/gi, "")
            .toLowerCase();
        return username;
    }
    static getUserDirectoryFromGuild(guild, username) {
        return path.join(this.getGuildDirectoryFromGuild(guild), username);
    }
    static getUserContentsFromName(client, message, username, search = false) {
        return Resources.getUserContentsFromNameWithGuild(client, message.guild, message, username, search);
    }
    static getUserContentsFromNameWithGuild(client, guild, message, username, search = false) {
        if (!guild)
            guild = message.guild;
        username = username.trim().toLowerCase();
        let jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
        if (!fs.existsSync(jsonFile)) {
            if (!search)
                return null;
            let possibleMatches = [];
            let users = this.getGuildUsersFromGuild(client, guild);
            const keys = Object.keys(users);
            for (const guildUserUsername of keys) {
                if (guildUserUsername.includes(username))
                    possibleMatches.push(guildUserUsername);
            }
            if (possibleMatches.length > 1) {
                let listOfUsers = "";
                for (var i = 0; i < possibleMatches.length; i++)
                    listOfUsers += `${i + 1}) ${possibleMatches[i]}`;
                message.reply(`there are multiple users which contain [${username}], please select the correct one:\n${listOfUsers}`).then(() => {
                    message.channel
                        .awaitMessages((response) => response.author === message.author, {
                        max: 1,
                        time: 1000 * 60,
                        errors: ["time"]
                    })
                        .then((collected) => {
                        let answer = parseInt(collected.first().content);
                        if (answer < 1 || answer > possibleMatches.length) {
                            message.reply("you did not enter a valid number, no user has been selected");
                            return;
                        }
                        username = possibleMatches[answer - 1];
                        jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
                    })
                        .catch(() => {
                        message.reply("you did not respond in time, no user has been selected");
                        return null;
                    });
                });
            }
            else if (possibleMatches.length == 1) {
                username = possibleMatches[0];
                jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
            }
            else {
                return null;
            }
        }
        let json = fs.readFileSync(jsonFile);
        let content = JSON.parse(json.toString());
        return content;
    }
    static getGuildNameFromGuild(guild) {
        let guildName = guild.name.replace(/[\W\s]/gi, "_");
        return `${guildName}-(${guild.id})`;
    }
    static getGuildDirectoryFromGuild(guild) {
        return path.join(__dirname, "..", "guilds", this.getGuildNameFromGuild(guild));
    }
    static getGuildDirectoryFromName(guildname) {
        return path.join(__dirname, "..", "guilds", guildname);
    }
    static getGuildUsersFromGuild(client, guild) {
        let entries = Object.entries(client.usersInSession);
        for (const [guildname, users] of entries)
            if (guildname == this.getGuildNameFromGuild(guild))
                return users;
        return null;
    }
    static createUserDirectory(client, guild, member) {
        let content = user_config_1.default;
        content.hidden.username = this.getUsernameFromMember(member);
        content.hidden.guildname = this.getGuildNameFromGuild(guild);
        let date = member.joinedAt;
        let joinedAt = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        content.misc.joined = joinedAt;
        let dir = this.getUserDirectoryFromGuild(guild, content.hidden.username);
        fs.mkdirSync(dir, { recursive: true });
        fs.writeFileSync(`${dir}/${content.hidden.username}.json`, JSON.stringify(content, null, "\t"));
        fs.mkdirSync(`${dir}/logs`, { recursive: true });
        let rolesUserHas = member.roles;
        let rankRolesUserHas = [];
        if (rolesUserHas.size != 0) {
            let entries = Object.entries(ranks_1.default._info);
            for (var i = 0; i < entries.length; i++) {
                let rank = entries[i][0].toLowerCase();
                let role = member.roles.find(role => role.name.toLowerCase() === rank);
                if (role) {
                    rankRolesUserHas.push(role);
                    content.rank.name = rank;
                    content.rank.xp = ranks_1.default._info[rank];
                    for (var level in ranks_1.default.levels) {
                        if (ranks_1.default.levels[level].toLowerCase() === rank) {
                            content.rank.level = parseInt(level);
                            content.rank.levelup = this.getXPToLevelUp(content.rank.xp, content.rank.level);
                            break;
                        }
                    }
                }
            }
        }
        rankRolesUserHas.splice(-1, 1);
        rankRolesUserHas.forEach(role => {
            member.roles.remove(role).catch(err => {
                console.log(err);
            });
        });
        client.registerUser(content);
        return content;
    }
    static destroyUserDirectory(guild, username) {
        let source = this.getUserDirectoryFromGuild(guild, username);
        rimraf(source, err => {
            if (err)
                console.log(err);
        });
    }
    static writeUserContentToFile(client, username, content) {
        Object.defineProperty(content, "hidden", {
            enumerable: true
        });
        let dir = path.join(this.getGuildDirectoryFromName(content.hidden.guildname), username);
        if (!fs.existsSync(dir))
            return console.error(`!! Attempted to write [${username}] contents to log, but no directory exists at [${dir}]`.red);
        if (content.userLog && content.userLog.length != 0) {
            for (var i = 0; i < content.userLog.length; i++)
                fs.appendFileSync(`${dir}/logs/${client.global_config.files.log_all}`, content.userLog[i]);
            content.userLog = [];
        }
        fs.writeFileSync(`${dir}/${username}.json`, JSON.stringify(content, null, "\t"));
    }
    static getXPToLevelUp(xp, level) {
        return xp + Math.round((4 * Math.pow(level, 3)) / 5);
    }
}
exports.default = Resources;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzb3VyY2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsYXNzZXMvUmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsa0JBQWdCO0FBR2hCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsaUNBQWlDO0FBRWpDLDhDQUF1QztBQUN2QywwREFBMkM7QUFFM0MsTUFBcUIsU0FBUztJQUM1QixNQUFNLENBQUMsc0JBQXNCLENBQUMsT0FBZ0I7UUFDNUMsSUFBSSxRQUFnQixDQUFDO1FBQ3JCLElBQUksT0FBTyxDQUFDLE1BQU07WUFBRSxRQUFRLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7O1lBQ3BFLE9BQU8sSUFBSSxDQUFDO1FBRWpCLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUUzRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxDQUFDLHFCQUFxQixDQUFDLE1BQVc7UUFDdEMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDMUQsUUFBUSxHQUFHLFFBQVE7YUFDaEIsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7YUFDakIsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7YUFDeEIsV0FBVyxFQUFFLENBQUM7UUFFakIsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxLQUFZLEVBQUUsUUFBZ0I7UUFDN0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FB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QUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2RCxDQUFDO0NBQ0Y7QUFuTUQsNEJBbU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xyXG5cclxuaW1wb3J0IHsgR3VpbGQsIEd1aWxkTWVtYmVyLCBNZXNzYWdlLCBSb2xlIH0gZnJvbSAnZGlzY29yZC5qcyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgcmltcmFmIGZyb20gJ3JpbXJhZic7XHJcblxyXG5pbXBvcnQgcmFua3MgZnJvbSAnLi4vcmVzb3VyY2VzL3JhbmtzJztcclxuaW1wb3J0IGRlZiBmcm9tICcuLi9yZXNvdXJjZXMvdXNlcl9jb25maWcnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVzb3VyY2VzIHtcclxuICBzdGF0aWMgZ2V0VXNlcm5hbWVGcm9tTWVzc2FnZShtZXNzYWdlOiBNZXNzYWdlKTogYW55IHtcclxuICAgIGxldCB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgaWYgKG1lc3NhZ2UubWVtYmVyKSB1c2VybmFtZSA9IG1lc3NhZ2UubWVtYmVyLnVzZXIudGFnLnJlcGxhY2UoXCIjXCIsIFwiX1wiKTtcclxuICAgIGVsc2UgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgdXNlcm5hbWUgPSB1c2VybmFtZS5yZXBsYWNlKC9bXlxcd1xcc10vZ2ksIFwiXCIpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgcmV0dXJuIHVzZXJuYW1lO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJuYW1lRnJvbU1lbWJlcihtZW1iZXI6IGFueSk6IHN0cmluZyB7XHJcbiAgICBsZXQgdXNlcm5hbWUgPSBtZW1iZXIudXNlciA/IG1lbWJlci51c2VyLnRhZyA6IG1lbWJlci50YWc7XHJcbiAgICB1c2VybmFtZSA9IHVzZXJuYW1lXHJcbiAgICAgIC5yZXBsYWNlKFwiI1wiLCBcIl9cIilcclxuICAgICAgLnJlcGxhY2UoL1teXFx3XFxzXS9naSwgXCJcIilcclxuICAgICAgLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgcmV0dXJuIHVzZXJuYW1lO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJEaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQ6IEd1aWxkLCB1c2VybmFtZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBwYXRoLmpvaW4odGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21HdWlsZChndWlsZCksIHVzZXJuYW1lKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBnZXRVc2VyQ29udGVudHNGcm9tTmFtZShjbGllbnQ6IGFueSwgbWVzc2FnZTogTWVzc2FnZSwgdXNlcm5hbWU6IHN0cmluZywgc2VhcmNoOiBib29sZWFuID0gZmFsc2UpOiBhbnkge1xyXG4gICAgcmV0dXJuIFJlc291cmNlcy5nZXRVc2VyQ29udGVudHNGcm9tTmFtZVdpdGhHdWlsZChjbGllbnQsIG1lc3NhZ2UuZ3VpbGQgYXMgR3VpbGQsIG1lc3NhZ2UsIHVzZXJuYW1lLCBzZWFyY2gpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJDb250ZW50c0Zyb21OYW1lV2l0aEd1aWxkKGNsaWVudDogYW55LCBndWlsZDogR3VpbGQsIG1lc3NhZ2U6IE1lc3NhZ2UsIHVzZXJuYW1lOiBzdHJpbmcsIHNlYXJjaDogYm9vbGVhbiA9IGZhbHNlKTogYW55IHtcclxuICAgIGlmICghZ3VpbGQpIGd1aWxkID0gbWVzc2FnZS5ndWlsZCBhcyBHdWlsZDtcclxuICAgIHVzZXJuYW1lID0gdXNlcm5hbWUudHJpbSgpLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgbGV0IGpzb25GaWxlID0gcGF0aC5qb2luKHRoaXMuZ2V0R3VpbGREaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQpLCB1c2VybmFtZSwgdXNlcm5hbWUgKyBcIi5qc29uXCIpO1xyXG5cclxuICAgIGlmICghZnMuZXhpc3RzU3luYyhqc29uRmlsZSkpIHtcclxuICAgICAgaWYgKCFzZWFyY2gpIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgbGV0IHBvc3NpYmxlTWF0Y2hlczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAgIGxldCB1c2VycyA9IHRoaXMuZ2V0R3VpbGRVc2Vyc0Zyb21HdWlsZChjbGllbnQsIGd1aWxkKTtcclxuXHJcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh1c2Vycyk7XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGd1aWxkVXNlclVzZXJuYW1lIG9mIGtleXMpIHtcclxuICAgICAgICBpZiAoZ3VpbGRVc2VyVXNlcm5hbWUuaW5jbHVkZXModXNlcm5hbWUpKSBwb3NzaWJsZU1hdGNoZXMucHVzaChndWlsZFVzZXJVc2VybmFtZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChwb3NzaWJsZU1hdGNoZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIGxldCBsaXN0T2ZVc2VycyA9IFwiXCI7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3NzaWJsZU1hdGNoZXMubGVuZ3RoOyBpKyspIGxpc3RPZlVzZXJzICs9IGAke2kgKyAxfSkgJHtwb3NzaWJsZU1hdGNoZXNbaV19YDtcclxuXHJcbiAgICAgICAgbWVzc2FnZS5yZXBseShgdGhlcmUgYXJlIG11bHRpcGxlIHVzZXJzIHdoaWNoIGNvbnRhaW4gWyR7dXNlcm5hbWV9XSwgcGxlYXNlIHNlbGVjdCB0aGUgY29ycmVjdCBvbmU6XFxuJHtsaXN0T2ZVc2Vyc31gKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgIG1lc3NhZ2UuY2hhbm5lbFxyXG4gICAgICAgICAgICAuYXdhaXRNZXNzYWdlcygocmVzcG9uc2U6IGFueSkgPT4gcmVzcG9uc2UuYXV0aG9yID09PSBtZXNzYWdlLmF1dGhvciwge1xyXG4gICAgICAgICAgICAgIG1heDogMSxcclxuICAgICAgICAgICAgICB0aW1lOiAxMDAwICogNjAsXHJcbiAgICAgICAgICAgICAgZXJyb3JzOiBbXCJ0aW1lXCJdXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKChjb2xsZWN0ZWQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIGxldCBhbnN3ZXIgPSBwYXJzZUludChjb2xsZWN0ZWQuZmlyc3QoKS5jb250ZW50KTtcclxuICAgICAgICAgICAgICBpZiAoYW5zd2VyIDwgMSB8fCBhbnN3ZXIgPiBwb3NzaWJsZU1hdGNoZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnJlcGx5KFwieW91IGRpZCBub3QgZW50ZXIgYSB2YWxpZCBudW1iZXIsIG5vIHVzZXIgaGFzIGJlZW4gc2VsZWN0ZWRcIik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICB1c2VybmFtZSA9IHBvc3NpYmxlTWF0Y2hlc1thbnN3ZXIgLSAxXTtcclxuICAgICAgICAgICAgICBqc29uRmlsZSA9IHBhdGguam9pbih0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkKSwgdXNlcm5hbWUsIHVzZXJuYW1lICsgXCIuanNvblwiKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICBtZXNzYWdlLnJlcGx5KFwieW91IGRpZCBub3QgcmVzcG9uZCBpbiB0aW1lLCBubyB1c2VyIGhhcyBiZWVuIHNlbGVjdGVkXCIpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIGlmIChwb3NzaWJsZU1hdGNoZXMubGVuZ3RoID09IDEpIHtcclxuICAgICAgICB1c2VybmFtZSA9IHBvc3NpYmxlTWF0Y2hlc1swXTtcclxuICAgICAgICBqc29uRmlsZSA9IHBhdGguam9pbih0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkKSwgdXNlcm5hbWUsIHVzZXJuYW1lICsgXCIuanNvblwiKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBqc29uID0gZnMucmVhZEZpbGVTeW5jKGpzb25GaWxlKTtcclxuICAgIGxldCBjb250ZW50ID0gSlNPTi5wYXJzZShqc29uLnRvU3RyaW5nKCkpO1xyXG5cclxuICAgIHJldHVybiBjb250ZW50O1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZDogR3VpbGQpOiBzdHJpbmcge1xyXG4gICAgbGV0IGd1aWxkTmFtZSA9IGd1aWxkLm5hbWUucmVwbGFjZSgvW1xcV1xcc10vZ2ksIFwiX1wiKTtcclxuICAgIHJldHVybiBgJHtndWlsZE5hbWV9LSgke2d1aWxkLmlkfSlgO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkOiBHdWlsZCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcImd1aWxkc1wiLCB0aGlzLmdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZCkpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEd1aWxkRGlyZWN0b3J5RnJvbU5hbWUoZ3VpbGRuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi5cIiwgXCJndWlsZHNcIiwgZ3VpbGRuYW1lKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBnZXRHdWlsZFVzZXJzRnJvbUd1aWxkKGNsaWVudDogYW55LCBndWlsZDogYW55KTogYW55IHtcclxuICAgIGxldCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoY2xpZW50LnVzZXJzSW5TZXNzaW9uKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtndWlsZG5hbWUsIHVzZXJzXSBvZiBlbnRyaWVzKSBpZiAoZ3VpbGRuYW1lID09IHRoaXMuZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkKSkgcmV0dXJuIHVzZXJzO1xyXG5cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLy9jcmVhdGVzIHRoZSB1c2VyIGRpcmVjdG9yeVxyXG4gIHN0YXRpYyBjcmVhdGVVc2VyRGlyZWN0b3J5KGNsaWVudDogYW55LCBndWlsZDogR3VpbGQsIG1lbWJlcjogR3VpbGRNZW1iZXIpOiBhbnkge1xyXG4gICAgbGV0IGNvbnRlbnQ6IGFueSA9IGRlZjtcclxuXHJcbiAgICBjb250ZW50LmhpZGRlbi51c2VybmFtZSA9IHRoaXMuZ2V0VXNlcm5hbWVGcm9tTWVtYmVyKG1lbWJlcik7XHJcbiAgICBjb250ZW50LmhpZGRlbi5ndWlsZG5hbWUgPSB0aGlzLmdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZCk7XHJcblxyXG4gICAgbGV0IGRhdGUgPSBtZW1iZXIuam9pbmVkQXQ7XHJcbiAgICBsZXQgam9pbmVkQXQgPSBgJHtkYXRlIS5nZXRNb250aCgpICsgMX0vJHtkYXRlIS5nZXREYXRlKCl9LyR7ZGF0ZSEuZ2V0RnVsbFllYXIoKX1gO1xyXG4gICAgY29udGVudC5taXNjLmpvaW5lZCA9IGpvaW5lZEF0O1xyXG5cclxuICAgIGxldCBkaXIgPSB0aGlzLmdldFVzZXJEaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQsIGNvbnRlbnQuaGlkZGVuLnVzZXJuYW1lKTtcclxuXHJcbiAgICBmcy5ta2RpclN5bmMoZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMoYCR7ZGlyfS8ke2NvbnRlbnQuaGlkZGVuLnVzZXJuYW1lfS5qc29uYCwgSlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgXCJcXHRcIikpO1xyXG4gICAgZnMubWtkaXJTeW5jKGAke2Rpcn0vbG9nc2AsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xyXG5cclxuICAgIGxldCByb2xlc1VzZXJIYXMgPSBtZW1iZXIucm9sZXM7XHJcbiAgICBsZXQgcmFua1JvbGVzVXNlckhhczogUm9sZVtdID0gW107XHJcblxyXG4gICAgLy9pZiB0aGUgdXNlciBhbHJlYWR5IGhhcyBwcmUtZXhpc3Rpbmcgcm9sZXNcclxuICAgIGlmIChyb2xlc1VzZXJIYXMuc2l6ZSAhPSAwKSB7XHJcbiAgICAgIGxldCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMocmFua3MuX2luZm8pO1xyXG5cclxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgbGV0IHJhbmsgPSBlbnRyaWVzW2ldWzBdLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgbGV0IHJvbGUgPSBtZW1iZXIucm9sZXMuZmluZChyb2xlID0+IHJvbGUubmFtZS50b0xvd2VyQ2FzZSgpID09PSByYW5rKTtcclxuXHJcbiAgICAgICAgaWYgKHJvbGUpIHtcclxuICAgICAgICAgIHJhbmtSb2xlc1VzZXJIYXMucHVzaChyb2xlKTtcclxuXHJcbiAgICAgICAgICBjb250ZW50LnJhbmsubmFtZSA9IHJhbms7XHJcbiAgICAgICAgICBjb250ZW50LnJhbmsueHAgPSByYW5rcy5faW5mb1tyYW5rXTtcclxuXHJcbiAgICAgICAgICBmb3IgKHZhciBsZXZlbCBpbiByYW5rcy5sZXZlbHMpIHtcclxuICAgICAgICAgICAgaWYgKHJhbmtzLmxldmVsc1tsZXZlbF0udG9Mb3dlckNhc2UoKSA9PT0gcmFuaykge1xyXG4gICAgICAgICAgICAgIGNvbnRlbnQucmFuay5sZXZlbCA9IHBhcnNlSW50KGxldmVsKTtcclxuICAgICAgICAgICAgICBjb250ZW50LnJhbmsubGV2ZWx1cCA9IHRoaXMuZ2V0WFBUb0xldmVsVXAoY29udGVudC5yYW5rLnhwLCBjb250ZW50LnJhbmsubGV2ZWwpO1xyXG5cclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJhbmtSb2xlc1VzZXJIYXMuc3BsaWNlKC0xLCAxKTtcclxuICAgIHJhbmtSb2xlc1VzZXJIYXMuZm9yRWFjaChyb2xlID0+IHtcclxuICAgICAgbWVtYmVyLnJvbGVzLnJlbW92ZShyb2xlKS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY2xpZW50LnJlZ2lzdGVyVXNlcihjb250ZW50KTtcclxuXHJcbiAgICByZXR1cm4gY29udGVudDtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBkZXN0cm95VXNlckRpcmVjdG9yeShndWlsZDogR3VpbGQsIHVzZXJuYW1lOiBzdHJpbmcpIHtcclxuICAgIGxldCBzb3VyY2UgPSB0aGlzLmdldFVzZXJEaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQsIHVzZXJuYW1lKTtcclxuICAgIHJpbXJhZihzb3VyY2UsIGVyciA9PiB7XHJcbiAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyB3cml0ZVVzZXJDb250ZW50VG9GaWxlKGNsaWVudDogYW55LCB1c2VybmFtZTogc3RyaW5nLCBjb250ZW50OiBhbnkpIHtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb250ZW50LCBcImhpZGRlblwiLCB7XHJcbiAgICAgIGVudW1lcmFibGU6IHRydWVcclxuICAgIH0pO1xyXG5cclxuICAgIGxldCBkaXIgPSBwYXRoLmpvaW4odGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21OYW1lKGNvbnRlbnQuaGlkZGVuLmd1aWxkbmFtZSksIHVzZXJuYW1lKTtcclxuXHJcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyKSkgcmV0dXJuIGNvbnNvbGUuZXJyb3IoYCEhIEF0dGVtcHRlZCB0byB3cml0ZSBbJHt1c2VybmFtZX1dIGNvbnRlbnRzIHRvIGxvZywgYnV0IG5vIGRpcmVjdG9yeSBleGlzdHMgYXQgWyR7ZGlyfV1gLnJlZCk7XHJcblxyXG4gICAgaWYgKGNvbnRlbnQudXNlckxvZyAmJiBjb250ZW50LnVzZXJMb2cubGVuZ3RoICE9IDApIHtcclxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZW50LnVzZXJMb2cubGVuZ3RoOyBpKyspIGZzLmFwcGVuZEZpbGVTeW5jKGAke2Rpcn0vbG9ncy8ke2NsaWVudC5nbG9iYWxfY29uZmlnLmZpbGVzLmxvZ19hbGx9YCwgY29udGVudC51c2VyTG9nW2ldKTtcclxuXHJcbiAgICAgIGNvbnRlbnQudXNlckxvZyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGZzLndyaXRlRmlsZVN5bmMoYCR7ZGlyfS8ke3VzZXJuYW1lfS5qc29uYCwgSlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgXCJcXHRcIikpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFhQVG9MZXZlbFVwKHhwOiBudW1iZXIsIGxldmVsOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHhwICsgTWF0aC5yb3VuZCgoNCAqIE1hdGgucG93KGxldmVsLCAzKSkgLyA1KTtcclxuICB9XHJcbn1cclxuIl19