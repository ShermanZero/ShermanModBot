"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("colors");
const Discord = require("discord.js");
const fs = require("fs");
const path = require("path");
const Resources_1 = require("./classes/Resources");
const global_config_1 = require("./resources/global_config");
let client = new Discord.Client();
init();
start();
client.login(global_config_1.default.token);
function init() {
    client.global_config = global_config_1.default;
    client.usersInSession = new Map();
    client.masterLog = [];
    client.guild_configs = new Map();
    client.getGuild = function (guildName) {
        return client.usersInSession[guildName];
    };
    client.updateUser = function (content) {
        var guildName = content.hidden.guildname;
        var username = content.hidden.username;
        var guild = client.usersInSession[guildName];
        guild[username] = content;
        content = client.hideUserInfo(content);
    };
    client.registerUser = function (content) {
        client.updateUser(content);
        console.log("*Registered [" + content.hidden.username.magenta + "] to guild [" + content.hidden.guildname.magenta + "]");
    };
    client.hideUserInfo = function (content) {
        Object.defineProperty(content, "hidden", {
            enumerable: false
        });
        return content;
    };
    client.hasUser = function (guild, username) {
        var userGuild = client.usersInSession[Resources_1.default.getGuildNameFromGuild(guild)];
        if (userGuild === null || typeof userGuild === "undefined")
            return false;
        var user = userGuild[username];
        return !(user === null || typeof user === "undefined");
    };
    client.getUserContent = function (guild, username) {
        var guildName = Resources_1.default.getGuildNameFromGuild(guild);
        var userGuild = client.usersInSession[guildName];
        if (userGuild === null) {
            console.error(("!! Could not retrieve [" + username + "'s] guild").red);
            return null;
        }
        if (userGuild[username] === null || typeof userGuild[username] === "undefined") {
            console.error(("!! Could not locate [" + username + "] in [" + guildName + "]").red);
            return null;
        }
        return userGuild[username];
    };
    client.removeUser = function (guild, username) {
        var userGuild = client.usersInSession[Resources_1.default.getGuildNameFromGuild(guild)];
        if (userGuild === null || typeof userGuild === "undefined")
            return;
        userGuild["delete"](username);
    };
    client.deleteUser = function (guild, username) {
        client.removeUser(guild, username);
        Resources_1.default.destroyUserDirectory(guild, username);
    };
}
function start() {
    var eventsPath = path.join(__dirname, "events");
    fs.readdir(eventsPath, function (err, files) {
        if (err)
            return console.error(err);
        files.forEach(function (file) {
            if (!file.endsWith(".js"))
                return;
            var event = require(path.join(__dirname, "events", file));
            var eventName = file.split(".")[0];
            console.log("--registering event", eventName);
            client.on(eventName, event.bind(null, client));
            delete require.cache[require.resolve(path.join(__dirname, "events", file))];
        });
    });
    client.commands = new Map();
    var commandsPath = path.join(__dirname, "commands");
    fs.readdir(commandsPath, function (err, files) {
        if (err)
            return console.error(err);
        files.forEach(function (file) {
            if (!file.endsWith(".js"))
                return;
            var props = require(path.join(__dirname, "commands", file));
            var commandName = file.split(".")[0];
            console.log("--registering command", commandName, props);
            client.commands.set(commandName, props);
            console.log("--set command", commandName, props);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrQkFBZ0I7QUFFaEIsc0NBQXNDO0FBQ3RDLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsbURBQXVDO0FBQ3ZDLDZEQUFzRDtBQUV0RCxJQUFJLE1BQU0sR0FBUSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUV2QyxJQUFJLEVBQUUsQ0FBQztBQUNQLEtBQUssRUFBRSxDQUFDO0FBRVIsTUFBTSxDQUFDLEtBQUssQ0FBQyx1QkFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRWxDLFNBQVMsSUFBSTtJQUNYLE1BQU0sQ0FBQyxhQUFhLEdBQUcsdUJBQWEsQ0FBQztJQUNyQyxNQUFNLENBQUMsY0FBYyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFDbEMsTUFBTSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDdEIsTUFBTSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRWpDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsVUFBUyxTQUFpQjtRQUMxQyxPQUFPLE1BQU0sQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDMUMsQ0FBQyxDQUFDO0lBRUYsTUFBTSxDQUFDLFVBQVUsR0FBRyxVQUFTLE9BQVk7UUFDdkMsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDekMsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDdkMsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM3QyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzFCLE9BQU8sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3pDLENBQUMsQ0FB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QUNuQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVMsSUFBSTtZQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7Z0JBQUUsT0FBTztZQUNsQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDNUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVyQyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN6RCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuXG5pbXBvcnQgKiBhcyBEaXNjb3JkIGZyb20gJ2Rpc2NvcmQuanMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHJzcmMgZnJvbSAnLi9jbGFzc2VzL1Jlc291cmNlcyc7XG5pbXBvcnQgZ2xvYmFsX2NvbmZpZyBmcm9tICcuL3Jlc291cmNlcy9nbG9iYWxfY29uZmlnJztcblxubGV0IGNsaWVudDogYW55ID0gbmV3IERpc2NvcmQuQ2xpZW50KCk7XG5cbmluaXQoKTtcbnN0YXJ0KCk7XG5cbmNsaWVudC5sb2dpbihnbG9iYWxfY29uZmlnLnRva2VuKTtcblxuZnVuY3Rpb24gaW5pdCgpIHtcbiAgY2xpZW50Lmdsb2JhbF9jb25maWcgPSBnbG9iYWxfY29uZmlnO1xuICBjbGllbnQudXNlcnNJblNlc3Npb24gPSBuZXcgTWFwKCk7XG4gIGNsaWVudC5tYXN0ZXJMb2cgPSBbXTtcbiAgY2xpZW50Lmd1aWxkX2NvbmZpZ3MgPSBuZXcgTWFwKCk7XG5cbiAgY2xpZW50LmdldEd1aWxkID0gZnVuY3Rpb24oZ3VpbGROYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gY2xpZW50LnVzZXJzSW5TZXNzaW9uW2d1aWxkTmFtZV07XG4gIH07XG5cbiAgY2xpZW50LnVwZGF0ZVVzZXIgPSBmdW5jdGlvbihjb250ZW50OiBhbnkpIHtcbiAgICB2YXIgZ3VpbGROYW1lID0gY29udGVudC5oaWRkZW4uZ3VpbGRuYW1lO1xuICAgIHZhciB1c2VybmFtZSA9IGNvbnRlbnQuaGlkZGVuLnVzZXJuYW1lO1xuICAgIHZhciBndWlsZCA9IGNsaWVudC51c2Vyc0luU2Vzc2lvbltndWlsZE5hbWVdO1xuICAgIGd1aWxkW3VzZXJuYW1lXSA9IGNvbnRlbnQ7XG4gICAgY29udGVudCA9IGNsaWVudC5oaWRlVXNlckluZm8oY29udGVudCk7XG4gIH07XG5cbiAgY2xpZW50LnJlZ2lzdGVyVXNlciA9IGZ1bmN0aW9uKGNvbnRlbnQ6IGFueSkge1xuICAgIGNsaWVudC51cGRhdGVVc2VyKGNvbnRlbnQpO1xuICAgIGNvbnNvbGUubG9nKFwiKlJlZ2lzdGVyZWQgW1wiICsgY29udGVudC5oaWRkZW4udXNlcm5hbWUubWFnZW50YSArIFwiXSB0byBndWlsZCBbXCIgKyBjb250ZW50LmhpZGRlbi5ndWlsZG5hbWUubWFnZW50YSArIFwiXVwiKTtcbiAgfTtcblxuICBjbGllbnQuaGlkZVVzZXJJbmZvID0gZnVuY3Rpb24oY29udGVudDogYW55KSB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnRlbnQsIFwiaGlkZGVuXCIsIHtcbiAgICAgIGVudW1lcmFibGU6IGZhbHNlXG4gICAgfSk7XG5cbiAgICByZXR1cm4gY29udGVudDtcbiAgfVxuXG4gIGNsaWVudC5oYXNVc2VyID0gZnVuY3Rpb24oZ3VpbGQ6IERpc2NvcmQuR3VpbGQsIHVzZXJuYW1lOiBzdHJpbmcpIHtcbiAgICB2YXIgdXNlckd1aWxkID0gY2xpZW50LnVzZXJzSW5TZXNzaW9uW3JzcmMuZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkKV07XG4gICAgaWYgKHVzZXJHdWlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgdXNlckd1aWxkID09PSBcInVuZGVmaW5lZFwiKSByZXR1cm4gZmFsc2U7XG5cbiAgICB2YXIgdXNlciA9IHVzZXJHdWlsZFt1c2VybmFtZV07XG4gICAgcmV0dXJuICEodXNlciA9PT0gbnVsbCB8fCB0eXBlb2YgdXNlciA9PT0gXCJ1bmRlZmluZWRcIik7XG4gIH07XG5cbiAgY2xpZW50LmdldFVzZXJDb250ZW50ID0gZnVuY3Rpb24oZ3VpbGQ6IERpc2NvcmQuR3VpbGQsIHVzZXJuYW1lOiBzdHJpbmcpIHtcbiAgICB2YXIgZ3VpbGROYW1lID0gcnNyYy5nZXRHdWlsZE5hbWVGcm9tR3VpbGQoZ3VpbGQpO1xuICAgIHZhciB1c2VyR3VpbGQgPSBjbGllbnQudXNlcnNJblNlc3Npb25bZ3VpbGROYW1lXTtcblxuICAgIGlmICh1c2VyR3VpbGQgPT09IG51bGwpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoKFwiISEgQ291bGQgbm90IHJldHJpZXZlIFtcIiArIHVzZXJuYW1lICsgXCInc10gZ3VpbGRcIikucmVkKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGlmICh1c2VyR3VpbGRbdXNlcm5hbWVdID09PSBudWxsIHx8IHR5cGVvZiB1c2VyR3VpbGRbdXNlcm5hbWVdID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBjb25zb2xlLmVycm9yKChcIiEhIENvdWxkIG5vdCBsb2NhdGUgW1wiICsgdXNlcm5hbWUgKyBcIl0gaW4gW1wiICsgZ3VpbGROYW1lICsgXCJdXCIpLnJlZCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdXNlckd1aWxkW3VzZXJuYW1lXTtcbiAgfTtcblxuICBjbGllbnQucmVtb3ZlVXNlciA9IGZ1bmN0aW9uKGd1aWxkOiBEaXNjb3JkLkd1aWxkLCB1c2VybmFtZTogc3RyaW5nKSB7XG4gICAgdmFyIHVzZXJHdWlsZCA9IGNsaWVudC51c2Vyc0luU2Vzc2lvbltyc3JjLmdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZCldO1xuICAgIGlmICh1c2VyR3VpbGQgPT09IG51bGwgfHwgdHlwZW9mIHVzZXJHdWlsZCA9PT0gXCJ1bmRlZmluZWRcIikgcmV0dXJuO1xuXG4gICAgdXNlckd1aWxkW1wiZGVsZXRlXCJdKHVzZXJuYW1lKTtcbiAgfTtcblxuICBjbGllbnQuZGVsZXRlVXNlciA9IGZ1bmN0aW9uKGd1aWxkOiBEaXNjb3JkLkd1aWxkLCB1c2VybmFtZTogc3RyaW5nKSB7XG4gICAgY2xpZW50LnJlbW92ZVVzZXIoZ3VpbGQsIHVzZXJuYW1lKTtcbiAgICByc3JjLmRlc3Ryb3lVc2VyRGlyZWN0b3J5KGd1aWxkLCB1c2VybmFtZSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHN0YXJ0KCkge1xuICB2YXIgZXZlbnRzUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiZXZlbnRzXCIpO1xuICBmcy5yZWFkZGlyKGV2ZW50c1BhdGgsIGZ1bmN0aW9uKGVyciwgZmlsZXMpIHtcbiAgICBpZiAoZXJyKSByZXR1cm4gY29uc29sZS5lcnJvcihlcnIpO1xuICAgIGZpbGVzLmZvckVhY2goZnVuY3Rpb24oZmlsZSkge1xuICAgICAgaWYgKCFmaWxlLmVuZHNXaXRoKFwiLmpzXCIpKSByZXR1cm47XG4gICAgICB2YXIgZXZlbnQgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsIFwiZXZlbnRzXCIsIGZpbGUpKSBhcyBGdW5jdGlvbjtcbiAgICAgIHZhciBldmVudE5hbWUgPSBmaWxlLnNwbGl0KFwiLlwiKVswXTtcblxuICAgICAgY29uc29sZS5sb2coXCItLXJlZ2lzdGVyaW5nIGV2ZW50XCIsIGV2ZW50TmFtZSk7XG4gICAgICBjbGllbnQub24oZXZlbnROYW1lLCBldmVudC5iaW5kKG51bGwsIGNsaWVudCkpO1xuICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKHBhdGguam9pbihfX2Rpcm5hbWUsIFwiZXZlbnRzXCIsIGZpbGUpKV07XG4gICAgfSk7XG4gIH0pO1xuXG4gIGNsaWVudC5jb21tYW5kcyA9IG5ldyBNYXAoKTtcbiAgdmFyIGNvbW1hbmRzUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiY29tbWFuZHNcIik7XG5cbiAgZnMucmVhZGRpcihjb21tYW5kc1BhdGgsIGZ1bmN0aW9uKGVyciwgZmlsZXMpIHtcbiAgICBpZiAoZXJyKSByZXR1cm4gY29uc29sZS5lcnJvcihlcnIpO1xuICAgIGZpbGVzLmZvckVhY2goZnVuY3Rpb24oZmlsZSkge1xuICAgICAgaWYgKCFmaWxlLmVuZHNXaXRoKFwiLmpzXCIpKSByZXR1cm47XG4gICAgICB2YXIgcHJvcHMgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsIFwiY29tbWFuZHNcIiwgZmlsZSkpO1xuICAgICAgdmFyIGNvbW1hbmROYW1lID0gZmlsZS5zcGxpdChcIi5cIilbMF07XG5cbiAgICAgIGNvbnNvbGUubG9nKFwiLS1yZWdpc3RlcmluZyBjb21tYW5kXCIsIGNvbW1hbmROYW1lLCBwcm9wcyk7XG4gICAgICBjbGllbnQuY29tbWFuZHMuc2V0KGNvbW1hbmROYW1lLCBwcm9wcyk7XG5cbiAgICAgIGNvbnNvbGUubG9nKFwiLS1zZXQgY29tbWFuZFwiLCBjb21tYW5kTmFtZSwgcHJvcHMpO1xuICAgIH0pO1xuICB9KTtcbn1cbiJdfQ==