"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("colors");
const fs = require("fs");
const path = require("path");
const rimraf = require("rimraf");
const ranks_1 = require("../resources/ranks/ranks");
class Resources {
    static getUsernameFromMessage(message) {
        let username;
        if (message.member)
            username = message.member.user.tag.replace("#", "_");
        else
            return null;
        username = username.replace(/[^\w\s]/gi, "").toLowerCase();
        return username;
    }
    static getUsernameFromMember(member) {
        let username = member.user ? member.user.tag : member.tag;
        username = username
            .replace("#", "_")
            .replace(/[^\w\s]/gi, "")
            .toLowerCase();
        return username;
    }
    static getUserDirectoryFromGuild(guild, username) {
        return path.join(this.getGuildDirectoryFromGuild(guild), username);
    }
    static getUserContentsFromName(message, username, search = false) {
        console.log("username", username);
        return Resources.getUserContentsFromNameWithGuild(message.guild, message, username, search);
    }
    static getUserContentsFromNameWithGuild(guild, message, username, search = false) {
        if (!guild)
            guild = message.guild;
        console.log("username", username);
        username = username.trim().toLowerCase();
        let jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
        if (!fs.existsSync(jsonFile)) {
            if (!search)
                return null;
            let possibleMatches = [];
            let users = this.getGuildUsersFromGuild(guild);
            for (let guildUserUsername in Object.keys(users))
                if (guildUserUsername.includes(username))
                    possibleMatches.push(guildUserUsername);
            if (possibleMatches.length > 1) {
                let listOfUsers = "";
                for (var i = 0; i < possibleMatches.length; i++)
                    listOfUsers += `${i + 1}) ${possibleMatches[i]}`;
                message
                    .reply(`there are multiple users which contain [${username}], please select the correct one:\n${listOfUsers}`)
                    .then(() => {
                    message.channel
                        .awaitMessages((response) => response.author === message.author, {
                        max: 1,
                        time: 1000 * 60,
                        errors: ["time"]
                    })
                        .then((collected) => {
                        let answer = parseInt(collected.first().content);
                        if (answer < 1 || answer > possibleMatches.length) {
                            message.reply("you did not enter a valid number, no user has been selected");
                            return;
                        }
                        username = possibleMatches[answer - 1];
                        jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
                    })
                        .catch(() => {
                        message.reply("you did not respond in time, no user has been selected");
                        return null;
                    });
                });
            }
        }
        let json = fs.readFileSync(jsonFile);
        let content = JSON.parse(json.toString());
        return content;
    }
    static getGuildNameFromGuild(guild) {
        let guildName = guild.name.replace(/[\W\s]/gi, "_");
        return `${guildName}-(${guild.id})`;
    }
    static getGuildDirectoryFromGuild(guild) {
        return path.join(__dirname, "..", "users", this.getGuildNameFromGuild(guild));
    }
    static getGuildDirectoryFromName(guildname) {
        return path.join(__dirname, "..", "users", guildname);
    }
    static getGuildUsersFromGuild(guild) {
        for (const [guildname, users] of guild)
            if (guildname == this.getGuildNameFromGuild(guild))
                return users;
        return null;
    }
    static createUserDirectory(client, guild, member) {
        let basePath = path.join(__dirname, "..", "users", "content.json");
        let json = fs.readFileSync(basePath);
        let content = JSON.parse(json.toString());
        content.hidden.username = this.getUsernameFromMember(member);
        content.hidden.guildname = this.getGuildNameFromGuild(guild);
        let date = member.joinedAt;
        let joinedAt = `${date.getMonth() +
            1}/${date.getDate()}/${date.getFullYear()}`;
        content.misc.joined = joinedAt;
        let dir = this.getUserDirectoryFromGuild(guild, content.hidden.username);
        fs.mkdirSync(dir);
        fs.writeFileSync(`${dir}/${content.hidden.username}.json`, JSON.stringify(content, null, "\t"));
        fs.mkdirSync(`${dir}/logs`);
        let rolesUserHas = member.roles;
        let rankRolesUserHas = [];
        if (rolesUserHas.size != 0) {
            let entries = Object.entries(ranks_1.default._info);
            for (var i = 0; i < entries.length; i++) {
                let rank = entries[i][0].toLowerCase();
                let role = member.roles.find(role => role.name.toLowerCase() === rank);
                if (role) {
                    rankRolesUserHas.push(role);
                    content.rank.name = rank;
                    content.rank.xp = ranks_1.default._info[rank];
                    for (var level in ranks_1.default.levels) {
                        if (ranks_1.default.levels[level].toLowerCase() === rank) {
                            content.rank.level = parseInt(level);
                            content.rank.levelup = this.getXPToLevelUp(content.rank.xp, content.rank.level);
                            break;
                        }
                    }
                }
            }
        }
        rankRolesUserHas.splice(-1, 1);
        rankRolesUserHas.forEach(role => {
            member.roles.remove(role).catch(err => {
                console.log(err);
            });
        });
        client.registerUser(content);
        return content;
    }
    static destroyUserDirectory(guild, username) {
        let source = this.getUserDirectoryFromGuild(guild, username);
        rimraf(source, err => {
            if (err)
                console.log(err);
        });
    }
    static writeUserContentToFile(client, username, content) {
        Object.defineProperty(content, "hidden", {
            enumerable: true
        });
        let dir = path.join(this.getGuildDirectoryFromName(content.hidden.guildname), username);
        if (!fs.existsSync(dir))
            return console.error(`!! Attempted to write [${username}] contents to log, but no directory exists at [${dir}]`
                .red);
        if (content.userLog && content.userLog.length != 0) {
            for (var i = 0; i < content.userLog.length; i++)
                fs.appendFileSync(`${dir}/logs/${client.config.files.log_all}`, content.userLog[i]);
            content.userLog = [];
        }
        fs.writeFileSync(`${dir}/${username}.json`, JSON.stringify(content, null, "\t"));
    }
    static getXPToLevelUp(xp, level) {
        return xp + Math.round((4 * Math.pow(level, 3)) / 5);
    }
}
exports.default = Resources;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzb3VyY2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsYXNzZXMvUmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsa0JBQWdCO0FBR2hCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsaUNBQWlDO0FBRWpDLG9EQUE2QztBQUU3QyxNQUFxQixTQUFTO0lBQzVCLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxPQUFnQjtRQUM1QyxJQUFJLFFBQWdCLENBQUM7UUFDckIsSUFBRyxPQUFPLENBQUMsTUFBTTtZQUNmLFFBQVEsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQzs7WUFDbEQsT0FBTyxJQUFJLENBQUM7UUFFakIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRTNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxNQUFNLENBQUMscUJBQXFCLENBQUMsTUFBVztRQUN0QyxJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUMxRCxRQUFRLEdBQUcsUUFBUTthQUNoQixPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQzthQUNqQixPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQzthQUN4QixXQUFXLEVBQUUsQ0FBQztRQUVqQixPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxDQUFDLHlCQUF5QixDQUFDLEtBQVksRUFBRSxRQUFnQjtRQUM3RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxF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WyJpbXBvcnQgJ2NvbG9ycyc7XHJcblxyXG5pbXBvcnQgeyBHdWlsZCwgR3VpbGRNZW1iZXIsIE1lc3NhZ2UsIFJvbGUgfSBmcm9tICdkaXNjb3JkLmpzJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgKiBhcyByaW1yYWYgZnJvbSAncmltcmFmJztcclxuXHJcbmltcG9ydCByYW5rcyBmcm9tICcuLi9yZXNvdXJjZXMvcmFua3MvcmFua3MnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVzb3VyY2VzIHtcclxuICBzdGF0aWMgZ2V0VXNlcm5hbWVGcm9tTWVzc2FnZShtZXNzYWdlOiBNZXNzYWdlKTogYW55IHtcclxuICAgIGxldCB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgaWYobWVzc2FnZS5tZW1iZXIpXHJcbiAgICAgIHVzZXJuYW1lID0gbWVzc2FnZS5tZW1iZXIudXNlci50YWcucmVwbGFjZShcIiNcIiwgXCJfXCIpO1xyXG4gICAgZWxzZSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICB1c2VybmFtZSA9IHVzZXJuYW1lLnJlcGxhY2UoL1teXFx3XFxzXS9naSwgXCJcIikudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4gdXNlcm5hbWU7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0VXNlcm5hbWVGcm9tTWVtYmVyKG1lbWJlcjogYW55KTogc3RyaW5nIHtcclxuICAgIGxldCB1c2VybmFtZSA9IG1lbWJlci51c2VyID8gbWVtYmVyLnVzZXIudGFnIDogbWVtYmVyLnRhZztcclxuICAgIHVzZXJuYW1lID0gdXNlcm5hbWVcclxuICAgICAgLnJlcGxhY2UoXCIjXCIsIFwiX1wiKVxyXG4gICAgICAucmVwbGFjZSgvW15cXHdcXHNdL2dpLCBcIlwiKVxyXG4gICAgICAudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4gdXNlcm5hbWU7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0VXNlckRpcmVjdG9yeUZyb21HdWlsZChndWlsZDogR3VpbGQsIHVzZXJuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkKSwgdXNlcm5hbWUpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJDb250ZW50c0Zyb21OYW1lKFxyXG4gICAgbWVzc2FnZTogTWVzc2FnZSxcclxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXHJcbiAgICBzZWFyY2g6IGJvb2xlYW4gPSBmYWxzZVxyXG4gICk6IGFueSB7XHJcbiAgICBjb25zb2xlLmxvZyhcInVzZXJuYW1lXCIsIHVzZXJuYW1lKTtcclxuXHJcbiAgICByZXR1cm4gUmVzb3VyY2VzLmdldFVzZXJDb250ZW50c0Zyb21OYW1lV2l0aEd1aWxkKFxyXG4gICAgICBtZXNzYWdlLmd1aWxkIGFzIEd1aWxkLFxyXG4gICAgICBtZXNzYWdlLFxyXG4gICAgICB1c2VybmFtZSxcclxuICAgICAgc2VhcmNoXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJDb250ZW50c0Zyb21OYW1lV2l0aEd1aWxkKFxyXG4gICAgZ3VpbGQ6IEd1aWxkLFxyXG4gICAgbWVzc2FnZTogTWVzc2FnZSxcclxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXHJcbiAgICBzZWFyY2g6IGJvb2xlYW4gPSBmYWxzZVxyXG4gICk6IGFueSB7XHJcbiAgICBpZiAoIWd1aWxkKSBndWlsZCA9IG1lc3NhZ2UuZ3VpbGQgYXMgR3VpbGQ7XHJcbiAgICBjb25zb2xlLmxvZyhcInVzZXJuYW1lXCIsIHVzZXJuYW1lKTtcclxuXHJcbiAgICB1c2VybmFtZSA9IHVzZXJuYW1lLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgIGxldCBqc29uRmlsZSA9IHBhdGguam9pbihcclxuICAgICAgdGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21HdWlsZChndWlsZCksXHJcbiAgICAgIHVzZXJuYW1lLFxyXG4gICAgICB1c2VybmFtZSArIFwiLmpzb25cIlxyXG4gICAgKTtcclxuXHJcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoanNvbkZpbGUpKSB7XHJcbiAgICAgIGlmICghc2VhcmNoKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAgIGxldCBwb3NzaWJsZU1hdGNoZXM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgICBsZXQgdXNlcnMgPSB0aGlzLmdldEd1aWxkVXNlcnNGcm9tR3VpbGQoZ3VpbGQpO1xyXG4gICAgICBmb3IgKGxldCBndWlsZFVzZXJVc2VybmFtZSBpbiBPYmplY3Qua2V5cyh1c2VycykpXHJcbiAgICAgICAgaWYgKGd1aWxkVXNlclVzZXJuYW1lLmluY2x1ZGVzKHVzZXJuYW1lKSlcclxuICAgICAgICAgIHBvc3NpYmxlTWF0Y2hlcy5wdXNoKGd1aWxkVXNlclVzZXJuYW1lKTtcclxuXHJcbiAgICAgIGlmIChwb3NzaWJsZU1hdGNoZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIGxldCBsaXN0T2ZVc2VycyA9IFwiXCI7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwb3NzaWJsZU1hdGNoZXMubGVuZ3RoOyBpKyspXHJcbiAgICAgICAgICBsaXN0T2ZVc2VycyArPSBgJHtpICsgMX0pICR7cG9zc2libGVNYXRjaGVzW2ldfWA7XHJcblxyXG4gICAgICAgIG1lc3NhZ2VcclxuICAgICAgICAgIC5yZXBseShcclxuICAgICAgICAgICAgYHRoZXJlIGFyZSBtdWx0aXBsZSB1c2VycyB3aGljaCBjb250YWluIFske3VzZXJuYW1lfV0sIHBsZWFzZSBzZWxlY3QgdGhlIGNvcnJlY3Qgb25lOlxcbiR7bGlzdE9mVXNlcnN9YFxyXG4gICAgICAgICAgKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWxcclxuICAgICAgICAgICAgICAuYXdhaXRNZXNzYWdlcyhcclxuICAgICAgICAgICAgICAgIChyZXNwb25zZTogYW55KSA9PiByZXNwb25zZS5hdXRob3IgPT09IG1lc3NhZ2UuYXV0aG9yLFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICBtYXg6IDEsXHJcbiAgICAgICAgICAgICAgICAgIHRpbWU6IDEwMDAgKiA2MCxcclxuICAgICAgICAgICAgICAgICAgZXJyb3JzOiBbXCJ0aW1lXCJdXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgIC50aGVuKChjb2xsZWN0ZWQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGFuc3dlciA9IHBhcnNlSW50KGNvbGxlY3RlZC5maXJzdCgpLmNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFuc3dlciA8IDEgfHwgYW5zd2VyID4gcG9zc2libGVNYXRjaGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICBtZXNzYWdlLnJlcGx5KFxyXG4gICAgICAgICAgICAgICAgICAgIFwieW91IGRpZCBub3QgZW50ZXIgYSB2YWxpZCBudW1iZXIsIG5vIHVzZXIgaGFzIGJlZW4gc2VsZWN0ZWRcIlxyXG4gICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBwb3NzaWJsZU1hdGNoZXNbYW5zd2VyIC0gMV07XHJcbiAgICAgICAgICAgICAgICBqc29uRmlsZSA9IHBhdGguam9pbihcclxuICAgICAgICAgICAgICAgICAgdGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21HdWlsZChndWlsZCksXHJcbiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lLFxyXG4gICAgICAgICAgICAgICAgICB1c2VybmFtZSArIFwiLmpzb25cIlxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnJlcGx5KFxyXG4gICAgICAgICAgICAgICAgICBcInlvdSBkaWQgbm90IHJlc3BvbmQgaW4gdGltZSwgbm8gdXNlciBoYXMgYmVlbiBzZWxlY3RlZFwiXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBqc29uID0gZnMucmVhZEZpbGVTeW5jKGpzb25GaWxlKTtcclxuICAgIGxldCBjb250ZW50ID0gSlNPTi5wYXJzZShqc29uLnRvU3RyaW5nKCkpO1xyXG5cclxuICAgIHJldHVybiBjb250ZW50O1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZDogR3VpbGQpOiBzdHJpbmcge1xyXG4gICAgbGV0IGd1aWxkTmFtZSA9IGd1aWxkLm5hbWUucmVwbGFjZSgvW1xcV1xcc10vZ2ksIFwiX1wiKTtcclxuICAgIHJldHVybiBgJHtndWlsZE5hbWV9LSgke2d1aWxkLmlkfSlgO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkOiBHdWlsZCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gcGF0aC5qb2luKFxyXG4gICAgICBfX2Rpcm5hbWUsXHJcbiAgICAgIFwiLi5cIixcclxuICAgICAgXCJ1c2Vyc1wiLFxyXG4gICAgICB0aGlzLmdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0R3VpbGREaXJlY3RvcnlGcm9tTmFtZShndWlsZG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcInVzZXJzXCIsIGd1aWxkbmFtZSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0R3VpbGRVc2Vyc0Zyb21HdWlsZChndWlsZDogYW55KTogYW55IHtcclxuICAgIGZvciAoY29uc3QgW2d1aWxkbmFtZSwgdXNlcnNdIG9mIGd1aWxkKVxyXG4gICAgICBpZiAoZ3VpbGRuYW1lID09IHRoaXMuZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkKSkgcmV0dXJuIHVzZXJzO1xyXG5cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLy9jcmVhdGVzIHRoZSB1c2VyIGRpcmVjdG9yeVxyXG4gIHN0YXRpYyBjcmVhdGVVc2VyRGlyZWN0b3J5KGNsaWVudDogYW55LCBndWlsZDogR3VpbGQsIG1lbWJlcjogR3VpbGRNZW1iZXIpOiBhbnkge1xyXG4gICAgbGV0IGJhc2VQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcInVzZXJzXCIsIFwiY29udGVudC5qc29uXCIpO1xyXG4gICAgbGV0IGpzb24gPSBmcy5yZWFkRmlsZVN5bmMoYmFzZVBhdGgpO1xyXG4gICAgbGV0IGNvbnRlbnQgPSBKU09OLnBhcnNlKGpzb24udG9TdHJpbmcoKSk7XHJcblxyXG4gICAgY29udGVudC5oaWRkZW4udXNlcm5hbWUgPSB0aGlzLmdldFVzZXJuYW1lRnJvbU1lbWJlcihtZW1iZXIpO1xyXG4gICAgY29udGVudC5oaWRkZW4uZ3VpbGRuYW1lID0gdGhpcy5nZXRHdWlsZE5hbWVGcm9tR3VpbGQoZ3VpbGQpO1xyXG5cclxuICAgIGxldCBkYXRlID0gbWVtYmVyLmpvaW5lZEF0O1xyXG4gICAgbGV0IGpvaW5lZEF0ID0gYCR7ZGF0ZSEuZ2V0TW9udGgoKSArXHJcbiAgICAgIDF9LyR7ZGF0ZSEuZ2V0RGF0ZSgpfS8ke2RhdGUhLmdldEZ1bGxZZWFyKCl9YDtcclxuICAgIGNvbnRlbnQubWlzYy5qb2luZWQgPSBqb2luZWRBdDtcclxuXHJcbiAgICBsZXQgZGlyID0gdGhpcy5nZXRVc2VyRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkLCBjb250ZW50LmhpZGRlbi51c2VybmFtZSk7XHJcblxyXG4gICAgZnMubWtkaXJTeW5jKGRpcik7XHJcbiAgICBmcy53cml0ZUZpbGVTeW5jKFxyXG4gICAgICBgJHtkaXJ9LyR7Y29udGVudC5oaWRkZW4udXNlcm5hbWV9Lmpzb25gLFxyXG4gICAgICBKU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCBcIlxcdFwiKVxyXG4gICAgKTtcclxuICAgIGZzLm1rZGlyU3luYyhgJHtkaXJ9L2xvZ3NgKTtcclxuXHJcbiAgICBsZXQgcm9sZXNVc2VySGFzID0gbWVtYmVyLnJvbGVzO1xyXG4gICAgbGV0IHJhbmtSb2xlc1VzZXJIYXM6IFJvbGVbXSA9IFtdO1xyXG5cclxuICAgIC8vaWYgdGhlIHVzZXIgYWxyZWFkeSBoYXMgcHJlLWV4aXN0aW5nIHJvbGVzXHJcbiAgICBpZiAocm9sZXNVc2VySGFzLnNpemUgIT0gMCkge1xyXG4gICAgICBsZXQgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHJhbmtzLl9pbmZvKTtcclxuXHJcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW50cmllcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCByYW5rID0gZW50cmllc1tpXVswXS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIGxldCByb2xlID0gbWVtYmVyLnJvbGVzLmZpbmQocm9sZSA9PiByb2xlLm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gcmFuayk7XHJcblxyXG4gICAgICAgIGlmIChyb2xlKSB7XHJcbiAgICAgICAgICByYW5rUm9sZXNVc2VySGFzLnB1c2gocm9sZSk7XHJcblxyXG4gICAgICAgICAgY29udGVudC5yYW5rLm5hbWUgPSByYW5rO1xyXG4gICAgICAgICAgY29udGVudC5yYW5rLnhwID0gcmFua3MuX2luZm9bcmFua107XHJcblxyXG4gICAgICAgICAgZm9yICh2YXIgbGV2ZWwgaW4gcmFua3MubGV2ZWxzKSB7XHJcbiAgICAgICAgICAgIGlmIChyYW5rcy5sZXZlbHNbbGV2ZWxdLnRvTG93ZXJDYXNlKCkgPT09IHJhbmspIHtcclxuICAgICAgICAgICAgICBjb250ZW50LnJhbmsubGV2ZWwgPSBwYXJzZUludChsZXZlbCk7XHJcbiAgICAgICAgICAgICAgY29udGVudC5yYW5rLmxldmVsdXAgPSB0aGlzLmdldFhQVG9MZXZlbFVwKFxyXG4gICAgICAgICAgICAgICAgY29udGVudC5yYW5rLnhwLFxyXG4gICAgICAgICAgICAgICAgY29udGVudC5yYW5rLmxldmVsXHJcbiAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByYW5rUm9sZXNVc2VySGFzLnNwbGljZSgtMSwgMSk7XHJcbiAgICByYW5rUm9sZXNVc2VySGFzLmZvckVhY2gocm9sZSA9PiB7XHJcbiAgICAgIG1lbWJlci5yb2xlcy5yZW1vdmUocm9sZSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGNsaWVudC5yZWdpc3RlclVzZXIoY29udGVudCk7XHJcblxyXG4gICAgcmV0dXJuIGNvbnRlbnQ7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZGVzdHJveVVzZXJEaXJlY3RvcnkoZ3VpbGQ6IEd1aWxkLCB1c2VybmFtZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgc291cmNlID0gdGhpcy5nZXRVc2VyRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkLCB1c2VybmFtZSk7XHJcbiAgICByaW1yYWYoc291cmNlLCBlcnIgPT4ge1xyXG4gICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgd3JpdGVVc2VyQ29udGVudFRvRmlsZShjbGllbnQ6IGFueSwgdXNlcm5hbWU6IHN0cmluZywgY29udGVudDogYW55KSB7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY29udGVudCwgXCJoaWRkZW5cIiwge1xyXG4gICAgICBlbnVtZXJhYmxlOiB0cnVlXHJcbiAgICB9KTtcclxuXHJcbiAgICBsZXQgZGlyID0gcGF0aC5qb2luKFxyXG4gICAgICB0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbU5hbWUoY29udGVudC5oaWRkZW4uZ3VpbGRuYW1lKSxcclxuICAgICAgdXNlcm5hbWVcclxuICAgICk7XHJcblxyXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpcikpXHJcbiAgICAgIHJldHVybiBjb25zb2xlLmVycm9yKFxyXG4gICAgICAgIGAhISBBdHRlbXB0ZWQgdG8gd3JpdGUgWyR7dXNlcm5hbWV9XSBjb250ZW50cyB0byBsb2csIGJ1dCBubyBkaXJlY3RvcnkgZXhpc3RzIGF0IFske2Rpcn1dYFxyXG4gICAgICAgICAgLnJlZFxyXG4gICAgICApO1xyXG5cclxuICAgIGlmIChjb250ZW50LnVzZXJMb2cgJiYgY29udGVudC51c2VyTG9nLmxlbmd0aCAhPSAwKSB7XHJcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29udGVudC51c2VyTG9nLmxlbmd0aDsgaSsrKVxyXG4gICAgICAgIGZzLmFwcGVuZEZpbGVTeW5jKFxyXG4gICAgICAgICAgYCR7ZGlyfS9sb2dzLyR7Y2xpZW50LmNvbmZpZy5maWxlcy5sb2dfYWxsfWAsXHJcbiAgICAgICAgICBjb250ZW50LnVzZXJMb2dbaV1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgY29udGVudC51c2VyTG9nID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgZnMud3JpdGVGaWxlU3luYyhcclxuICAgICAgYCR7ZGlyfS8ke3VzZXJuYW1lfS5qc29uYCxcclxuICAgICAgSlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgXCJcXHRcIilcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0WFBUb0xldmVsVXAoeHA6IG51bWJlciwgbGV2ZWw6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4geHAgKyBNYXRoLnJvdW5kKCg0ICogTWF0aC5wb3cobGV2ZWwsIDMpKSAvIDUpO1xyXG4gIH1cclxufSJdfQ==