"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("colors");
const fs = require("fs");
const path = require("path");
const rimraf = require("rimraf");
const ranks_1 = require("../resources/ranks/ranks");
const defaults_1 = require("../users/defaults");
class Resources {
    static getUsernameFromMessage(message) {
        let username;
        if (message.member)
            username = message.member.user.tag.replace("#", "_");
        else
            return null;
        username = username.replace(/[^\w\s]/gi, "").toLowerCase();
        return username;
    }
    static getUsernameFromMember(member) {
        let username = member.user ? member.user.tag : member.tag;
        username = username
            .replace("#", "_")
            .replace(/[^\w\s]/gi, "")
            .toLowerCase();
        return username;
    }
    static getUserDirectoryFromGuild(guild, username) {
        return path.join(this.getGuildDirectoryFromGuild(guild), username);
    }
    static getUserContentsFromName(client, message, username, search = false) {
        console.log("username", username);
        return Resources.getUserContentsFromNameWithGuild(client, message.guild, message, username, search);
    }
    static getUserContentsFromNameWithGuild(client, guild, message, username, search = false) {
        if (!guild)
            guild = message.guild;
        console.log("username", username);
        username = username.trim().toLowerCase();
        let jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
        if (!fs.existsSync(jsonFile)) {
            if (!search)
                return null;
            let possibleMatches = [];
            let users = this.getGuildUsersFromGuild(client, guild);
            for (let guildUserUsername in Object.keys(users))
                if (guildUserUsername.includes(username))
                    possibleMatches.push(guildUserUsername);
            if (possibleMatches.length > 1) {
                let listOfUsers = "";
                for (var i = 0; i < possibleMatches.length; i++)
                    listOfUsers += `${i + 1}) ${possibleMatches[i]}`;
                message
                    .reply(`there are multiple users which contain [${username}], please select the correct one:\n${listOfUsers}`)
                    .then(() => {
                    message.channel
                        .awaitMessages((response) => response.author === message.author, {
                        max: 1,
                        time: 1000 * 60,
                        errors: ["time"]
                    })
                        .then((collected) => {
                        let answer = parseInt(collected.first().content);
                        if (answer < 1 || answer > possibleMatches.length) {
                            message.reply("you did not enter a valid number, no user has been selected");
                            return;
                        }
                        username = possibleMatches[answer - 1];
                        jsonFile = path.join(this.getGuildDirectoryFromGuild(guild), username, username + ".json");
                    })
                        .catch(() => {
                        message.reply("you did not respond in time, no user has been selected");
                        return null;
                    });
                });
            }
        }
        let json = fs.readFileSync(jsonFile);
        let content = JSON.parse(json.toString());
        return content;
    }
    static getGuildNameFromGuild(guild) {
        let guildName = guild.name.replace(/[\W\s]/gi, "_");
        return `${guildName}-(${guild.id})`;
    }
    static getGuildDirectoryFromGuild(guild) {
        return path.join(__dirname, "..", "users", this.getGuildNameFromGuild(guild));
    }
    static getGuildDirectoryFromName(guildname) {
        return path.join(__dirname, "..", "users", guildname);
    }
    static getGuildUsersFromGuild(client, guild) {
        let entries = Object.entries(client.usersInSession);
        for (const [guildname, users] of entries)
            if (guildname == this.getGuildNameFromGuild(guild))
                return users;
        return null;
    }
    static createUserDirectory(client, guild, member) {
        let content = defaults_1.default;
        content.hidden.username = this.getUsernameFromMember(member);
        content.hidden.guildname = this.getGuildNameFromGuild(guild);
        let date = member.joinedAt;
        let joinedAt = `${date.getMonth() +
            1}/${date.getDate()}/${date.getFullYear()}`;
        content.misc.joined = joinedAt;
        let dir = this.getUserDirectoryFromGuild(guild, content.hidden.username);
        fs.mkdirSync(dir, { recursive: true });
        fs.writeFileSync(`${dir}/${content.hidden.username}.json`, JSON.stringify(content, null, "\t"));
        fs.mkdirSync(`${dir}/logs`, { recursive: true });
        let rolesUserHas = member.roles;
        let rankRolesUserHas = [];
        if (rolesUserHas.size != 0) {
            let entries = Object.entries(ranks_1.default._info);
            for (var i = 0; i < entries.length; i++) {
                let rank = entries[i][0].toLowerCase();
                let role = member.roles.find(role => role.name.toLowerCase() === rank);
                if (role) {
                    rankRolesUserHas.push(role);
                    content.rank.name = rank;
                    content.rank.xp = ranks_1.default._info[rank];
                    for (var level in ranks_1.default.levels) {
                        if (ranks_1.default.levels[level].toLowerCase() === rank) {
                            content.rank.level = parseInt(level);
                            content.rank.levelup = this.getXPToLevelUp(content.rank.xp, content.rank.level);
                            break;
                        }
                    }
                }
            }
        }
        rankRolesUserHas.splice(-1, 1);
        rankRolesUserHas.forEach(role => {
            member.roles.remove(role).catch(err => {
                console.log(err);
            });
        });
        client.registerUser(content);
        return content;
    }
    static destroyUserDirectory(guild, username) {
        let source = this.getUserDirectoryFromGuild(guild, username);
        rimraf(source, err => {
            if (err)
                console.log(err);
        });
    }
    static writeUserContentToFile(client, username, content) {
        Object.defineProperty(content, "hidden", {
            enumerable: true
        });
        let dir = path.join(this.getGuildDirectoryFromName(content.hidden.guildname), username);
        if (!fs.existsSync(dir))
            return console.error(`!! Attempted to write [${username}] contents to log, but no directory exists at [${dir}]`
                .red);
        if (content.userLog && content.userLog.length != 0) {
            for (var i = 0; i < content.userLog.length; i++)
                fs.appendFileSync(`${dir}/logs/${client.config.files.log_all}`, content.userLog[i]);
            content.userLog = [];
        }
        fs.writeFileSync(`${dir}/${username}.json`, JSON.stringify(content, null, "\t"));
    }
    static getXPToLevelUp(xp, level) {
        return xp + Math.round((4 * Math.pow(level, 3)) / 5);
    }
}
exports.default = Resources;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzb3VyY2VzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsYXNzZXMvUmVzb3VyY2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsa0JBQWdCO0FBR2hCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsaUNBQWlDO0FBRWpDLG9EQUE2QztBQUM3QyxnREFBb0M7QUFFcEMsTUFBcUIsU0FBUztJQUM1QixNQUFNLENBQUMsc0JBQXNCLENBQUMsT0FBZ0I7UUFDNUMsSUFBSSxRQUFnQixDQUFDO1FBQ3JCLElBQUcsT0FBTyxDQUFDLE1BQU07WUFDZixRQUFRLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7O1lBQ2xELE9BQU8sSUFBSSxDQUFDO1FBRWpCLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUUzRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxDQUFDLHFCQUFxQixDQUFDLE1BQVc7UUFDdEMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDMUQsUUFBUSxHQUFHLFFBQVE7YUFDaEIsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7YUFDakIsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7YUFDeEIsV0FBVyxFQUFFLENBQUM7UUFFakIsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxLQUFZLEVBQUUsUUFBZ0I7UUFDN0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FB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b250ZW50IjpbImltcG9ydCAnY29sb3JzJztcclxuXHJcbmltcG9ydCB7IEd1aWxkLCBHdWlsZE1lbWJlciwgTWVzc2FnZSwgUm9sZSB9IGZyb20gJ2Rpc2NvcmQuanMnO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIHJpbXJhZiBmcm9tICdyaW1yYWYnO1xyXG5cclxuaW1wb3J0IHJhbmtzIGZyb20gJy4uL3Jlc291cmNlcy9yYW5rcy9yYW5rcyc7XHJcbmltcG9ydCBkZWYgZnJvbSAnLi4vdXNlcnMvZGVmYXVsdHMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVzb3VyY2VzIHtcclxuICBzdGF0aWMgZ2V0VXNlcm5hbWVGcm9tTWVzc2FnZShtZXNzYWdlOiBNZXNzYWdlKTogYW55IHtcclxuICAgIGxldCB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgaWYobWVzc2FnZS5tZW1iZXIpXHJcbiAgICAgIHVzZXJuYW1lID0gbWVzc2FnZS5tZW1iZXIudXNlci50YWcucmVwbGFjZShcIiNcIiwgXCJfXCIpO1xyXG4gICAgZWxzZSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICB1c2VybmFtZSA9IHVzZXJuYW1lLnJlcGxhY2UoL1teXFx3XFxzXS9naSwgXCJcIikudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4gdXNlcm5hbWU7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0VXNlcm5hbWVGcm9tTWVtYmVyKG1lbWJlcjogYW55KTogc3RyaW5nIHtcclxuICAgIGxldCB1c2VybmFtZSA9IG1lbWJlci51c2VyID8gbWVtYmVyLnVzZXIudGFnIDogbWVtYmVyLnRhZztcclxuICAgIHVzZXJuYW1lID0gdXNlcm5hbWVcclxuICAgICAgLnJlcGxhY2UoXCIjXCIsIFwiX1wiKVxyXG4gICAgICAucmVwbGFjZSgvW15cXHdcXHNdL2dpLCBcIlwiKVxyXG4gICAgICAudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICByZXR1cm4gdXNlcm5hbWU7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0VXNlckRpcmVjdG9yeUZyb21HdWlsZChndWlsZDogR3VpbGQsIHVzZXJuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkKSwgdXNlcm5hbWUpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFVzZXJDb250ZW50c0Zyb21OYW1lKFxyXG4gICAgY2xpZW50OiBhbnksXHJcbiAgICBtZXNzYWdlOiBNZXNzYWdlLFxyXG4gICAgdXNlcm5hbWU6IHN0cmluZyxcclxuICAgIHNlYXJjaDogYm9vbGVhbiA9IGZhbHNlXHJcbiAgKTogYW55IHtcclxuICAgIGNvbnNvbGUubG9nKFwidXNlcm5hbWVcIiwgdXNlcm5hbWUpO1xyXG5cclxuICAgIHJldHVybiBSZXNvdXJjZXMuZ2V0VXNlckNvbnRlbnRzRnJvbU5hbWVXaXRoR3VpbGQoXHJcbiAgICAgIGNsaWVudCxcclxuICAgICAgbWVzc2FnZS5ndWlsZCBhcyBHdWlsZCxcclxuICAgICAgbWVzc2FnZSxcclxuICAgICAgdXNlcm5hbWUsXHJcbiAgICAgIHNlYXJjaFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBnZXRVc2VyQ29udGVudHNGcm9tTmFtZVdpdGhHdWlsZChcclxuICAgIGNsaWVudDogYW55LFxyXG4gICAgZ3VpbGQ6IEd1aWxkLFxyXG4gICAgbWVzc2FnZTogTWVzc2FnZSxcclxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXHJcbiAgICBzZWFyY2g6IGJvb2xlYW4gPSBmYWxzZVxyXG4gICk6IGFueSB7XHJcbiAgICBpZiAoIWd1aWxkKSBndWlsZCA9IG1lc3NhZ2UuZ3VpbGQgYXMgR3VpbGQ7XHJcbiAgICBjb25zb2xlLmxvZyhcInVzZXJuYW1lXCIsIHVzZXJuYW1lKTtcclxuXHJcbiAgICB1c2VybmFtZSA9IHVzZXJuYW1lLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgIGxldCBqc29uRmlsZSA9IHBhdGguam9pbihcclxuICAgICAgdGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21HdWlsZChndWlsZCksXHJcbiAgICAgIHVzZXJuYW1lLFxyXG4gICAgICB1c2VybmFtZSArIFwiLmpzb25cIlxyXG4gICAgKTtcclxuXHJcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoanNvbkZpbGUpKSB7XHJcbiAgICAgIGlmICghc2VhcmNoKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAgIGxldCBwb3NzaWJsZU1hdGNoZXM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgICBsZXQgdXNlcnMgPSB0aGlzLmdldEd1aWxkVXNlcnNGcm9tR3VpbGQoY2xpZW50LCBndWlsZCk7XHJcbiAgICAgIGZvciAobGV0IGd1aWxkVXNlclVzZXJuYW1lIGluIE9iamVjdC5rZXlzKHVzZXJzKSlcclxuICAgICAgICBpZiAoZ3VpbGRVc2VyVXNlcm5hbWUuaW5jbHVkZXModXNlcm5hbWUpKVxyXG4gICAgICAgICAgcG9zc2libGVNYXRjaGVzLnB1c2goZ3VpbGRVc2VyVXNlcm5hbWUpO1xyXG5cclxuICAgICAgaWYgKHBvc3NpYmxlTWF0Y2hlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgbGV0IGxpc3RPZlVzZXJzID0gXCJcIjtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvc3NpYmxlTWF0Y2hlcy5sZW5ndGg7IGkrKylcclxuICAgICAgICAgIGxpc3RPZlVzZXJzICs9IGAke2kgKyAxfSkgJHtwb3NzaWJsZU1hdGNoZXNbaV19YDtcclxuXHJcbiAgICAgICAgbWVzc2FnZVxyXG4gICAgICAgICAgLnJlcGx5KFxyXG4gICAgICAgICAgICBgdGhlcmUgYXJlIG11bHRpcGxlIHVzZXJzIHdoaWNoIGNvbnRhaW4gWyR7dXNlcm5hbWV9XSwgcGxlYXNlIHNlbGVjdCB0aGUgY29ycmVjdCBvbmU6XFxuJHtsaXN0T2ZVc2Vyc31gXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UuY2hhbm5lbFxyXG4gICAgICAgICAgICAgIC5hd2FpdE1lc3NhZ2VzKFxyXG4gICAgICAgICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHJlc3BvbnNlLmF1dGhvciA9PT0gbWVzc2FnZS5hdXRob3IsXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgIG1heDogMSxcclxuICAgICAgICAgICAgICAgICAgdGltZTogMTAwMCAqIDYwLFxyXG4gICAgICAgICAgICAgICAgICBlcnJvcnM6IFtcInRpbWVcIl1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgLnRoZW4oKGNvbGxlY3RlZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYW5zd2VyID0gcGFyc2VJbnQoY29sbGVjdGVkLmZpcnN0KCkuY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYW5zd2VyIDwgMSB8fCBhbnN3ZXIgPiBwb3NzaWJsZU1hdGNoZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgIG1lc3NhZ2UucmVwbHkoXHJcbiAgICAgICAgICAgICAgICAgICAgXCJ5b3UgZGlkIG5vdCBlbnRlciBhIHZhbGlkIG51bWJlciwgbm8gdXNlciBoYXMgYmVlbiBzZWxlY3RlZFwiXHJcbiAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHBvc3NpYmxlTWF0Y2hlc1thbnN3ZXIgLSAxXTtcclxuICAgICAgICAgICAgICAgIGpzb25GaWxlID0gcGF0aC5qb2luKFxyXG4gICAgICAgICAgICAgICAgICB0aGlzLmdldEd1aWxkRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkKSxcclxuICAgICAgICAgICAgICAgICAgdXNlcm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lICsgXCIuanNvblwiXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2UucmVwbHkoXHJcbiAgICAgICAgICAgICAgICAgIFwieW91IGRpZCBub3QgcmVzcG9uZCBpbiB0aW1lLCBubyB1c2VyIGhhcyBiZWVuIHNlbGVjdGVkXCJcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGpzb24gPSBmcy5yZWFkRmlsZVN5bmMoanNvbkZpbGUpO1xyXG4gICAgbGV0IGNvbnRlbnQgPSBKU09OLnBhcnNlKGpzb24udG9TdHJpbmcoKSk7XHJcblxyXG4gICAgcmV0dXJuIGNvbnRlbnQ7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkOiBHdWlsZCk6IHN0cmluZyB7XHJcbiAgICBsZXQgZ3VpbGROYW1lID0gZ3VpbGQubmFtZS5yZXBsYWNlKC9bXFxXXFxzXS9naSwgXCJfXCIpO1xyXG4gICAgcmV0dXJuIGAke2d1aWxkTmFtZX0tKCR7Z3VpbGQuaWR9KWA7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0R3VpbGREaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQ6IEd1aWxkKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBwYXRoLmpvaW4oXHJcbiAgICAgIF9fZGlybmFtZSxcclxuICAgICAgXCIuLlwiLFxyXG4gICAgICBcInVzZXJzXCIsXHJcbiAgICAgIHRoaXMuZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBnZXRHdWlsZERpcmVjdG9yeUZyb21OYW1lKGd1aWxkbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwidXNlcnNcIiwgZ3VpbGRuYW1lKTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBnZXRHdWlsZFVzZXJzRnJvbUd1aWxkKGNsaWVudDogYW55LCBndWlsZDogYW55KTogYW55IHtcclxuICAgIGxldCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoY2xpZW50LnVzZXJzSW5TZXNzaW9uKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtndWlsZG5hbWUsIHVzZXJzXSBvZiBlbnRyaWVzKVxyXG4gICAgICBpZiAoZ3VpbGRuYW1lID09IHRoaXMuZ2V0R3VpbGROYW1lRnJvbUd1aWxkKGd1aWxkKSkgcmV0dXJuIHVzZXJzO1xyXG5cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLy9jcmVhdGVzIHRoZSB1c2VyIGRpcmVjdG9yeVxyXG4gIHN0YXRpYyBjcmVhdGVVc2VyRGlyZWN0b3J5KGNsaWVudDogYW55LCBndWlsZDogR3VpbGQsIG1lbWJlcjogR3VpbGRNZW1iZXIpOiBhbnkge1xyXG4gICAgbGV0IGNvbnRlbnQ6IGFueSA9IGRlZjtcclxuXHJcbiAgICBjb250ZW50LmhpZGRlbi51c2VybmFtZSA9IHRoaXMuZ2V0VXNlcm5hbWVGcm9tTWVtYmVyKG1lbWJlcik7XHJcbiAgICBjb250ZW50LmhpZGRlbi5ndWlsZG5hbWUgPSB0aGlzLmdldEd1aWxkTmFtZUZyb21HdWlsZChndWlsZCk7XHJcblxyXG4gICAgbGV0IGRhdGUgPSBtZW1iZXIuam9pbmVkQXQ7XHJcbiAgICBsZXQgam9pbmVkQXQgPSBgJHtkYXRlIS5nZXRNb250aCgpICtcclxuICAgICAgMX0vJHtkYXRlIS5nZXREYXRlKCl9LyR7ZGF0ZSEuZ2V0RnVsbFllYXIoKX1gO1xyXG4gICAgY29udGVudC5taXNjLmpvaW5lZCA9IGpvaW5lZEF0O1xyXG5cclxuICAgIGxldCBkaXIgPSB0aGlzLmdldFVzZXJEaXJlY3RvcnlGcm9tR3VpbGQoZ3VpbGQsIGNvbnRlbnQuaGlkZGVuLnVzZXJuYW1lKTtcclxuXHJcbiAgICBmcy5ta2RpclN5bmMoZGlyLCB7cmVjdXJzaXZlOiB0cnVlfSk7XHJcbiAgICBmcy53cml0ZUZpbGVTeW5jKFxyXG4gICAgICBgJHtkaXJ9LyR7Y29udGVudC5oaWRkZW4udXNlcm5hbWV9Lmpzb25gLFxyXG4gICAgICBKU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCBcIlxcdFwiKVxyXG4gICAgKTtcclxuICAgIGZzLm1rZGlyU3luYyhgJHtkaXJ9L2xvZ3NgLCB7cmVjdXJzaXZlOiB0cnVlfSk7XHJcblxyXG4gICAgbGV0IHJvbGVzVXNlckhhcyA9IG1lbWJlci5yb2xlcztcclxuICAgIGxldCByYW5rUm9sZXNVc2VySGFzOiBSb2xlW10gPSBbXTtcclxuXHJcbiAgICAvL2lmIHRoZSB1c2VyIGFscmVhZHkgaGFzIHByZS1leGlzdGluZyByb2xlc1xyXG4gICAgaWYgKHJvbGVzVXNlckhhcy5zaXplICE9IDApIHtcclxuICAgICAgbGV0IGVudHJpZXMgPSBPYmplY3QuZW50cmllcyhyYW5rcy5faW5mbyk7XHJcblxyXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBsZXQgcmFuayA9IGVudHJpZXNbaV1bMF0udG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBsZXQgcm9sZSA9IG1lbWJlci5yb2xlcy5maW5kKHJvbGUgPT4gcm9sZS5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IHJhbmspO1xyXG5cclxuICAgICAgICBpZiAocm9sZSkge1xyXG4gICAgICAgICAgcmFua1JvbGVzVXNlckhhcy5wdXNoKHJvbGUpO1xyXG5cclxuICAgICAgICAgIGNvbnRlbnQucmFuay5uYW1lID0gcmFuaztcclxuICAgICAgICAgIGNvbnRlbnQucmFuay54cCA9IHJhbmtzLl9pbmZvW3JhbmtdO1xyXG5cclxuICAgICAgICAgIGZvciAodmFyIGxldmVsIGluIHJhbmtzLmxldmVscykge1xyXG4gICAgICAgICAgICBpZiAocmFua3MubGV2ZWxzW2xldmVsXS50b0xvd2VyQ2FzZSgpID09PSByYW5rKSB7XHJcbiAgICAgICAgICAgICAgY29udGVudC5yYW5rLmxldmVsID0gcGFyc2VJbnQobGV2ZWwpO1xyXG4gICAgICAgICAgICAgIGNvbnRlbnQucmFuay5sZXZlbHVwID0gdGhpcy5nZXRYUFRvTGV2ZWxVcChcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQucmFuay54cCxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQucmFuay5sZXZlbFxyXG4gICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmFua1JvbGVzVXNlckhhcy5zcGxpY2UoLTEsIDEpO1xyXG4gICAgcmFua1JvbGVzVXNlckhhcy5mb3JFYWNoKHJvbGUgPT4ge1xyXG4gICAgICBtZW1iZXIucm9sZXMucmVtb3ZlKHJvbGUpLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBjbGllbnQucmVnaXN0ZXJVc2VyKGNvbnRlbnQpO1xyXG5cclxuICAgIHJldHVybiBjb250ZW50O1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGRlc3Ryb3lVc2VyRGlyZWN0b3J5KGd1aWxkOiBHdWlsZCwgdXNlcm5hbWU6IHN0cmluZykge1xyXG4gICAgbGV0IHNvdXJjZSA9IHRoaXMuZ2V0VXNlckRpcmVjdG9yeUZyb21HdWlsZChndWlsZCwgdXNlcm5hbWUpO1xyXG4gICAgcmltcmFmKHNvdXJjZSwgZXJyID0+IHtcclxuICAgICAgaWYgKGVycikgY29uc29sZS5sb2coZXJyKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIHdyaXRlVXNlckNvbnRlbnRUb0ZpbGUoY2xpZW50OiBhbnksIHVzZXJuYW1lOiBzdHJpbmcsIGNvbnRlbnQ6IGFueSkge1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnRlbnQsIFwiaGlkZGVuXCIsIHtcclxuICAgICAgZW51bWVyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcblxyXG4gICAgbGV0IGRpciA9IHBhdGguam9pbihcclxuICAgICAgdGhpcy5nZXRHdWlsZERpcmVjdG9yeUZyb21OYW1lKGNvbnRlbnQuaGlkZGVuLmd1aWxkbmFtZSksXHJcbiAgICAgIHVzZXJuYW1lXHJcbiAgICApO1xyXG5cclxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKVxyXG4gICAgICByZXR1cm4gY29uc29sZS5lcnJvcihcclxuICAgICAgICBgISEgQXR0ZW1wdGVkIHRvIHdyaXRlIFske3VzZXJuYW1lfV0gY29udGVudHMgdG8gbG9nLCBidXQgbm8gZGlyZWN0b3J5IGV4aXN0cyBhdCBbJHtkaXJ9XWBcclxuICAgICAgICAgIC5yZWRcclxuICAgICAgKTtcclxuXHJcbiAgICBpZiAoY29udGVudC51c2VyTG9nICYmIGNvbnRlbnQudXNlckxvZy5sZW5ndGggIT0gMCkge1xyXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRlbnQudXNlckxvZy5sZW5ndGg7IGkrKylcclxuICAgICAgICBmcy5hcHBlbmRGaWxlU3luYyhcclxuICAgICAgICAgIGAke2Rpcn0vbG9ncy8ke2NsaWVudC5jb25maWcuZmlsZXMubG9nX2FsbH1gLFxyXG4gICAgICAgICAgY29udGVudC51c2VyTG9nW2ldXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgIGNvbnRlbnQudXNlckxvZyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGZzLndyaXRlRmlsZVN5bmMoXHJcbiAgICAgIGAke2Rpcn0vJHt1c2VybmFtZX0uanNvbmAsXHJcbiAgICAgIEpTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsIFwiXFx0XCIpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFhQVG9MZXZlbFVwKHhwOiBudW1iZXIsIGxldmVsOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHhwICsgTWF0aC5yb3VuZCgoNCAqIE1hdGgucG93KGxldmVsLCAzKSkgLyA1KTtcclxuICB9XHJcbn0iXX0=