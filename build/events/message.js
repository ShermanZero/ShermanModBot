"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("colors");
const fs = require("fs");
const path = require("path");
const Resources_1 = require("../classes/Resources");
const blacklist_1 = require("../resources/blacklist");
const global_config_1 = require("../resources/global_config");
const ranks_1 = require("../resources/ranks");
module.exports = (client, message) => {
    var _a, _b;
    if (message.author.bot)
        return;
    if (!registerMessage(client, message))
        return console.error(`!! Could not register message sent by [${Resources_1.default.getUsernameFromMessage(message)}]`.red);
    if (blacklist_1.default.words.some(substring => message.content.includes(substring))) {
        message.delete().catch(err => {
            console.log(err);
        });
        message.reply("that is not allowed here.").catch(err => {
            console.log(err);
        });
    }
    awardExperience(client, message);
    if (message.content.indexOf(client.global_config.prefix) !== 0)
        return;
    const args = message.content
        .slice(client.global_config.prefix.length)
        .trim()
        .split(/ +/g);
    let command;
    if (args)
        command = args.shift().toLowerCase();
    if (!command)
        return;
    const cmd = client.commands.get(command);
    if (!cmd)
        return;
    let guildDir = Resources_1.default.getGuildDirectoryFromGuild(message.guild);
    let guildConfigFile = path.resolve(guildDir, client.global_config.files.guild_config);
    let guildConfig;
    if (fs.existsSync(guildConfigFile))
        guildConfig = require(guildConfigFile);
    if (command != "config") {
        if (!((_a = guildConfig) === null || _a === void 0 ? void 0 : _a.setup))
            return message.reply("your guild owner has to configure me before I can execute commands :(");
        if (cmd.props.requiresElevation && cmd.props.requiresElevation !== "") {
            if (cmd.props.requiresElevation === "botowner" && message.member.user.tag != "ShermanZero#1200")
                return;
            else if (!((_b = message.member) === null || _b === void 0 ? void 0 : _b.roles.has(guildConfig.roles[cmd.props.requiresElevation])))
                return;
        }
    }
    cmd.run(client, message, args);
};
function registerMessage(client, message) {
    let username = Resources_1.default.getUsernameFromMessage(message);
    if (!message.guild)
        return;
    let guildName = Resources_1.default.getGuildNameFromGuild(message.guild);
    let userDir = Resources_1.default.getUserDirectoryFromGuild(message.guild, username);
    let content;
    if (!fs.existsSync(userDir))
        Resources_1.default.createUserDirectory(client, message.guild, message.member);
    if (!client.hasUser(message.guild, username)) {
        content = Resources_1.default.getUserContentsFromName(client, message, username);
        client.registerUser(message.member.user, content);
    }
    else {
        content = client.getUserContent(message.guild, username);
    }
    if (content === null || typeof content === "undefined") {
        console.error(`!! Could not retrieve contents for [${username}]`.red);
        return false;
    }
    if (content.misc.first_message === null || typeof content.misc.first_message === "undefined") {
        content.misc.first_message = message.content;
        client.updateUser(content);
    }
    let logMessage = `[${getTimestamp(message)}] (#${message.channel.name}): ${message.content}\n`;
    client.masterLog.push(`/${guildName}/>  ${username} ${logMessage}`);
    updateMasterLog(client);
    content.userLog.push(logMessage);
    updateUserLog(client, message.guild, content);
    return true;
}
function getTimestamp(message) {
    let timestamp = message.createdAt;
    let date = (timestamp.getMonth() + 1 + "/" + timestamp.getDate()).replace(/.*(\d{2}\/\d{2}).*/, "$1");
    let time = timestamp.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1");
    return date + "  " + time;
}
function updateMasterLog(client) {
    let masterLog = path.join(__dirname, "..", "logs");
    if (!fs.existsSync(masterLog)) {
        fs.mkdirSync(masterLog, { recursive: true });
        fs.writeFileSync(path.resolve(masterLog, global_config_1.default.files.log_all), "-- START OF LOG --");
    }
    if (client.masterLog.length >= client.global_config.preferences.log_threshold_master) {
        for (var i = 0; i < client.masterLog.length; i++)
            fs.appendFileSync(masterLog, client.masterLog[i]);
        client.masterLog = [];
    }
}
function updateUserLog(client, guild, content) {
    let logsDir = path.join(Resources_1.default.getUserDirectoryFromGuild(guild, content.hidden.username), "logs");
    let userLog = path.join(logsDir, client.global_config.files.log_all);
    if (content.userLog.length >= client.global_config.preferences.log_threshold_user) {
        for (var i = 0; i < content.userLog.length; i++)
            fs.appendFileSync(userLog, content.userLog[i]);
        content.userLog = [];
    }
    client.updateUser(content);
    console.log(`[${content.hidden.guildname.magenta}] =>`, `[${content.hidden.username.magenta}] =>`, content);
}
function awardExperience(client, message) {
    let username = Resources_1.default.getUsernameFromMessage(message);
    let content = client.getUserContent(message.guild, username);
    if (!content) {
        return console.error(`!! Could not retrieve contents from [${username}]`);
    }
    content.rank.xp += 1;
    if (content.rank.xp >= content.rank.levelup) {
        content.rank.level += 1;
        var rank = ranks_1.default.levels[content.rank.level];
        if (rank) {
            var lastRank = content.rank.name;
            content.rank.name = rank;
            let oldRole = message.guild.roles.find(role => role.name.toLowerCase() === lastRank.toLowerCase());
            let newRole = message.guild.roles.find(role => role.name.toLowerCase() === rank.toLowerCase());
            if (oldRole)
                message.member.removeRole(oldRole).catch(err => {
                    console.log(err);
                });
            message.member.addRole(newRole).catch(err => {
                console.log(err);
            });
        }
        content.rank.levelup = Resources_1.default.getXPToLevelUp(content.rank.xp, content.rank.level);
        levelUp(client, message, content);
    }
    client.updateUser(content);
    if (content.rank.xp % client.global_config.preferences.xp_threshold === 0) {
        let jsonFile = path.join(Resources_1.default.getUserDirectoryFromGuild(message.guild, username), username + ".json");
        let newJson = JSON.stringify(content, null, "\t");
        fs.writeFileSync(jsonFile, newJson);
    }
}
function levelUp(client, message, content) {
    var stats = client.commands.get("stats");
    let embed = stats.getEmbed(client, message.member, content);
    message.channel.send(`Congratulations ${message.author}!  You just leveled up!  Keep chatting to earn more XP and unlock roles and special perks!`);
    message.channel.send(embed);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ldmVudHMvbWVzc2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtCQUFnQjtBQUdoQix5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLG9EQUF3QztBQUN4QyxzREFBK0M7QUFDL0MsOERBQXVEO0FBQ3ZELDhDQUF1QztBQUV2QyxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsTUFBVyxFQUFFLE9BQWdCLEVBQUUsRUFBRTs7SUFFakQsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUc7UUFBRSxPQUFPO0lBRy9CLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQztRQUFFLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQywwQ0FBMEMsbUJBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBR25KLElBQUksbUJBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRTtRQUMxRSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLENBQUMsS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7S0FDSjtJQUVELGVBQWUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFHakMsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFN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Q0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFFNUQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLE9BQU8sQ0FBQyxNQUFNLDRGQUE0RixDQUFDLENBQUM7SUFDcEosT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcclxuXHJcbmltcG9ydCB7IE1lc3NhZ2UsIFRleHRDaGFubmVsIH0gZnJvbSAnZGlzY29yZC5qcyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmltcG9ydCByc3JjIGZyb20gJy4uL2NsYXNzZXMvUmVzb3VyY2VzJztcclxuaW1wb3J0IGJsYWNrbGlzdCBmcm9tICcuLi9yZXNvdXJjZXMvYmxhY2tsaXN0JztcclxuaW1wb3J0IGdsb2JhbF9jb25maWcgZnJvbSAnLi4vcmVzb3VyY2VzL2dsb2JhbF9jb25maWcnO1xyXG5pbXBvcnQgcmFua3MgZnJvbSAnLi4vcmVzb3VyY2VzL3JhbmtzJztcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gKGNsaWVudDogYW55LCBtZXNzYWdlOiBNZXNzYWdlKSA9PiB7XHJcbiAgLy9pZ25vcmUgYWxsIGJvdHNcclxuICBpZiAobWVzc2FnZS5hdXRob3IuYm90KSByZXR1cm47XHJcblxyXG4gIC8vcmVnaXN0ZXIgdGhlIHVzZXJcclxuICBpZiAoIXJlZ2lzdGVyTWVzc2FnZShjbGllbnQsIG1lc3NhZ2UpKSByZXR1cm4gY29uc29sZS5lcnJvcihgISEgQ291bGQgbm90IHJlZ2lzdGVyIG1lc3NhZ2Ugc2VudCBieSBbJHtyc3JjLmdldFVzZXJuYW1lRnJvbU1lc3NhZ2UobWVzc2FnZSl9XWAucmVkKTtcclxuXHJcbiAgLy9jaGVjayBhZ2FpbnN0IGJsYWNrbGlzdFxyXG4gIGlmIChibGFja2xpc3Qud29yZHMuc29tZShzdWJzdHJpbmcgPT4gbWVzc2FnZS5jb250ZW50LmluY2x1ZGVzKHN1YnN0cmluZykpKSB7XHJcbiAgICBtZXNzYWdlLmRlbGV0ZSgpLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICB9KTtcclxuICAgIG1lc3NhZ2UucmVwbHkoXCJ0aGF0IGlzIG5vdCBhbGxvd2VkIGhlcmUuXCIpLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGF3YXJkRXhwZXJpZW5jZShjbGllbnQsIG1lc3NhZ2UpO1xyXG5cclxuICAvL2lnbm9yZSBtZXNzYWdlcyBub3Qgc3RhcnRpbmcgd2l0aCB0aGUgcHJlZml4XHJcbiAgaWYgKG1lc3NhZ2UuY29udGVudC5pbmRleE9mKGNsaWVudC5nbG9iYWxfY29uZmlnLnByZWZpeCkgIT09IDApIHJldHVybjtcclxuXHJcbiAgLy9zdGFuZGFyZCBhcmd1bWVudC9jb21tYW5kIG5hbWUgZGVmaW5pdGlvblxyXG4gIGNvbnN0IGFyZ3M6IGFueSA9IG1lc3NhZ2UuY29udGVudFxyXG4gICAgLnNsaWNlKGNsaWVudC5nbG9iYWxfY29uZmlnLnByZWZpeC5sZW5ndGgpXHJcbiAgICAudHJpbSgpXHJcbiAgICAuc3BsaXQoLyArL2cpO1xyXG5cclxuICBsZXQgY29tbWFuZDogYW55O1xyXG4gIGlmIChhcmdzKSBjb21tYW5kID0gYXJncy5zaGlmdCgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgaWYgKCFjb21tYW5kKSByZXR1cm47XHJcblxyXG4gIC8vZ3JhYiB0aGUgY29tbWFuZCBkYXRhIGZyb20gdGhlIGNsaWVudC5jb21tYW5kcyBFbm1hcFxyXG4gIGNvbnN0IGNtZCA9IGNsaWVudC5jb21tYW5kcy5nZXQoY29tbWFuZCk7XHJcblxyXG4gIC8vaWYgdGhlIGNvbW1hbmQgZG9lc24ndCBleGlzdFxyXG4gIGlmICghY21kKSByZXR1cm47XHJcblxyXG4gIGxldCBndWlsZERpciA9IHJzcmMuZ2V0R3VpbGREaXJlY3RvcnlGcm9tR3VpbGQobWVzc2FnZS5ndWlsZCk7XHJcblxyXG4gIGxldCBndWlsZENvbmZpZ0ZpbGUgPSBwYXRoLnJlc29sdmUoZ3VpbGREaXIsIGNsaWVudC5nbG9iYWxfY29uZmlnLmZpbGVzLmd1aWxkX2NvbmZpZyk7XHJcbiAgbGV0IGd1aWxkQ29uZmlnOiBhbnk7XHJcbiAgaWYgKGZzLmV4aXN0c1N5bmMoZ3VpbGRDb25maWdGaWxlKSkgZ3VpbGRDb25maWcgPSByZXF1aXJlKGd1aWxkQ29uZmlnRmlsZSk7XHJcblxyXG4gIGlmIChjb21tYW5kICE9IFwiY29uZmlnXCIpIHtcclxuICAgIGlmICghZ3VpbGRDb25maWc/LnNldHVwKSByZXR1cm4gbWVzc2FnZS5yZXBseShcInlvdXIgZ3VpbGQgb3duZXIgaGFzIHRvIGNvbmZpZ3VyZSBtZSBiZWZvcmUgSSBjYW4gZXhlY3V0ZSBjb21tYW5kcyA6KFwiKTtcclxuICAgIGlmIChjbWQucHJvcHMucmVxdWlyZXNFbGV2YXRpb24gJiYgY21kLnByb3BzLnJlcXVpcmVzRWxldmF0aW9uICE9PSBcIlwiKSB7XHJcbiAgICAgIGlmIChjbWQucHJvcHMucmVxdWlyZXNFbGV2YXRpb24gPT09IFwiYm90b3duZXJcIiAmJiBtZXNzYWdlLm1lbWJlci51c2VyLnRhZyAhPSBcIlNoZXJtYW5aZXJvIzEyMDBcIikgcmV0dXJuO1xyXG4gICAgICBlbHNlIGlmICghbWVzc2FnZS5tZW1iZXI/LnJvbGVzLmhhcyhndWlsZENvbmZpZy5yb2xlc1tjbWQucHJvcHMucmVxdWlyZXNFbGV2YXRpb25dKSkgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy9ydW4gdGhlIGNvbW1hbmRcclxuICBjbWQucnVuKGNsaWVudCwgbWVzc2FnZSwgYXJncyk7XHJcbn07XHJcblxyXG4vL3JlZ2lzdGVycyB0aGUgbWVzc2FnZVxyXG5mdW5jdGlvbiByZWdpc3Rlck1lc3NhZ2UoY2xpZW50OiBhbnksIG1lc3NhZ2U6IE1lc3NhZ2UpIHtcclxuICBsZXQgdXNlcm5hbWUgPSByc3JjLmdldFVzZXJuYW1lRnJvbU1lc3NhZ2UobWVzc2FnZSk7XHJcblxyXG4gIGlmICghbWVzc2FnZS5ndWlsZCkgcmV0dXJuO1xyXG5cclxuICBsZXQgZ3VpbGROYW1lID0gcnNyYy5nZXRHdWlsZE5hbWVGcm9tR3VpbGQobWVzc2FnZS5ndWlsZCk7XHJcbiAgbGV0IHVzZXJEaXIgPSByc3JjLmdldFVzZXJEaXJlY3RvcnlGcm9tR3VpbGQobWVzc2FnZS5ndWlsZCwgdXNlcm5hbWUpO1xyXG5cclxuICBsZXQgY29udGVudDogYW55O1xyXG5cclxuICAvL2lmIHRoZSB1c2VyIGhhcyBub3QgYmVlbiByZWdpc3RlcmVkXHJcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHVzZXJEaXIpKSByc3JjLmNyZWF0ZVVzZXJEaXJlY3RvcnkoY2xpZW50LCBtZXNzYWdlLmd1aWxkLCBtZXNzYWdlLm1lbWJlciEpO1xyXG5cclxuICAvL3VzZXIgTk9UIHN0b3JlZCBpbiBsb2NhbCBjbGllbnQgc2Vzc2lvblxyXG4gIGlmICghY2xpZW50Lmhhc1VzZXIobWVzc2FnZS5ndWlsZCwgdXNlcm5hbWUpKSB7XHJcbiAgICBjb250ZW50ID0gcnNyYy5nZXRVc2VyQ29udGVudHNGcm9tTmFtZShjbGllbnQsIG1lc3NhZ2UsIHVzZXJuYW1lKTtcclxuICAgIGNsaWVudC5yZWdpc3RlclVzZXIobWVzc2FnZS5tZW1iZXIhLnVzZXIsIGNvbnRlbnQpO1xyXG4gICAgLy91c2VyIHN0b3JlZCBpbiBsb2NhbCBjbGllbnQgc2Vzc2lvblxyXG4gIH0gZWxzZSB7XHJcbiAgICBjb250ZW50ID0gY2xpZW50LmdldFVzZXJDb250ZW50KG1lc3NhZ2UuZ3VpbGQsIHVzZXJuYW1lKTtcclxuICB9XHJcblxyXG4gIGlmIChjb250ZW50ID09PSBudWxsIHx8IHR5cGVvZiBjb250ZW50ID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGAhISBDb3VsZCBub3QgcmV0cmlldmUgY29udGVudHMgZm9yIFske3VzZXJuYW1lfV1gLnJlZCk7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpZiAoY29udGVudC5taXNjLmZpcnN0X21lc3NhZ2UgPT09IG51bGwgfHwgdHlwZW9mIGNvbnRlbnQubWlzYy5maXJzdF9tZXNzYWdlID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICBjb250ZW50Lm1pc2MuZmlyc3RfbWVzc2FnZSA9IG1lc3NhZ2UuY29udGVudDtcclxuICAgIGNsaWVudC51cGRhdGVVc2VyKGNvbnRlbnQpO1xyXG4gIH1cclxuXHJcbiAgbGV0IGxvZ01lc3NhZ2UgPSBgWyR7Z2V0VGltZXN0YW1wKG1lc3NhZ2UpfV0gKCMkeyhtZXNzYWdlLmNoYW5uZWwgYXMgVGV4dENoYW5uZWwpLm5hbWV9KTogJHttZXNzYWdlLmNvbnRlbnR9XFxuYDtcclxuXHJcbiAgLy9wdXNoIHRoZSBtZXNzYWdlIHRvIHRoZSBtYXN0ZXIgbG9nIGJyYW5jaFxyXG4gIGNsaWVudC5tYXN0ZXJMb2cucHVzaChgLyR7Z3VpbGROYW1lfS8+ICAke3VzZXJuYW1lfSAke2xvZ01lc3NhZ2V9YCk7XHJcbiAgLy9pZiB0aGUgbG9nIGxlbmd0aCBleGNlZWRzIHRoZSB0aHJlc2hvbGQsIHVwZGF0ZSB0aGUgbWFzdGVyIGxvZ1xyXG4gIHVwZGF0ZU1hc3RlckxvZyhjbGllbnQpO1xyXG5cclxuICAvL3B1c2ggdGhlIHVzZXIncyBtZXNzYWdlIGRpcmVjdGx5IHRvIHRoZSB1c2VyJ3MgbG9nXHJcbiAgY29udGVudC51c2VyTG9nLnB1c2gobG9nTWVzc2FnZSk7XHJcbiAgLy9pZiB0aGUgbG9nIGxlbmd0aCBleGNlZWRzIHRoZSB0aHJlc2hvbGQsIHVwZGF0ZSB0aGUgdXNlciBsb2dcclxuICB1cGRhdGVVc2VyTG9nKGNsaWVudCwgbWVzc2FnZS5ndWlsZCwgY29udGVudCk7XHJcblxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRUaW1lc3RhbXAobWVzc2FnZTogTWVzc2FnZSkge1xyXG4gIGxldCB0aW1lc3RhbXAgPSBtZXNzYWdlLmNyZWF0ZWRBdDtcclxuICBsZXQgZGF0ZSA9ICh0aW1lc3RhbXAuZ2V0TW9udGgoKSArIDEgKyBcIi9cIiArIHRpbWVzdGFtcC5nZXREYXRlKCkpLnJlcGxhY2UoLy4qKFxcZHsyfVxcL1xcZHsyfSkuKi8sIFwiJDFcIik7XHJcbiAgbGV0IHRpbWUgPSB0aW1lc3RhbXAudG9UaW1lU3RyaW5nKCkucmVwbGFjZSgvLiooXFxkezJ9OlxcZHsyfTpcXGR7Mn0pLiovLCBcIiQxXCIpO1xyXG5cclxuICByZXR1cm4gZGF0ZSArIFwiICBcIiArIHRpbWU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZU1hc3RlckxvZyhjbGllbnQpIHtcclxuICBsZXQgbWFzdGVyTG9nID0gcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcImxvZ3NcIik7XHJcblxyXG4gIGlmICghZnMuZXhpc3RzU3luYyhtYXN0ZXJMb2cpKSB7XHJcbiAgICBmcy5ta2RpclN5bmMobWFzdGVyTG9nLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5yZXNvbHZlKG1hc3RlckxvZywgZ2xvYmFsX2NvbmZpZy5maWxlcy5sb2dfYWxsKSwgXCItLSBTVEFSVCBPRiBMT0cgLS1cIik7XHJcbiAgfVxyXG5cclxuICAvL2lmIHRoZSBsb2cgbGVuZ3RoIGV4Y2VlZHMgdGhlIHRocmVzaG9sZCwgdXBkYXRlIHRoZSBtYXN0ZXIgbG9nXHJcbiAgaWYgKGNsaWVudC5tYXN0ZXJMb2cubGVuZ3RoID49IGNsaWVudC5nbG9iYWxfY29uZmlnLnByZWZlcmVuY2VzLmxvZ190aHJlc2hvbGRfbWFzdGVyKSB7XHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsaWVudC5tYXN0ZXJMb2cubGVuZ3RoOyBpKyspIGZzLmFwcGVuZEZpbGVTeW5jKG1hc3RlckxvZywgY2xpZW50Lm1hc3RlckxvZ1tpXSk7XHJcblxyXG4gICAgY2xpZW50Lm1hc3RlckxvZyA9IFtdO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlVXNlckxvZyhjbGllbnQsIGd1aWxkLCBjb250ZW50KSB7XHJcbiAgbGV0IGxvZ3NEaXIgPSBwYXRoLmpvaW4ocnNyYy5nZXRVc2VyRGlyZWN0b3J5RnJvbUd1aWxkKGd1aWxkLCBjb250ZW50LmhpZGRlbi51c2VybmFtZSksIFwibG9nc1wiKTtcclxuICBsZXQgdXNlckxvZyA9IHBhdGguam9pbihsb2dzRGlyLCBjbGllbnQuZ2xvYmFsX2NvbmZpZy5maWxlcy5sb2dfYWxsKTtcclxuXHJcbiAgLy9pZiB0aGUgbG9nIGxlbmd0aCBleGNlZWRzIHRoZSB0aHJlc2hvbGQsIHVwZGF0ZSB0aGUgbWFzdGVyIGxvZ1xyXG4gIGlmIChjb250ZW50LnVzZXJMb2cubGVuZ3RoID49IGNsaWVudC5nbG9iYWxfY29uZmlnLnByZWZlcmVuY2VzLmxvZ190aHJlc2hvbGRfdXNlcikge1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZW50LnVzZXJMb2cubGVuZ3RoOyBpKyspIGZzLmFwcGVuZEZpbGVTeW5jKHVzZXJMb2csIGNvbnRlbnQudXNlckxvZ1tpXSk7XHJcblxyXG4gICAgY29udGVudC51c2VyTG9nID0gW107XHJcbiAgfVxyXG5cclxuICAvL2hhdmUgdG8gdXBkYXRlIHRoZSBFbm1hcFxyXG4gIGNsaWVudC51cGRhdGVVc2VyKGNvbnRlbnQpO1xyXG5cclxuICAvL2xvZyBpdCB0byB0aGUgY29uc29sZVxyXG4gIGNvbnNvbGUubG9nKGBbJHtjb250ZW50LmhpZGRlbi5ndWlsZG5hbWUubWFnZW50YX1dID0+YCwgYFske2NvbnRlbnQuaGlkZGVuLnVzZXJuYW1lLm1hZ2VudGF9XSA9PmAsIGNvbnRlbnQpO1xyXG59XHJcblxyXG4vL2F3YXJkcyB0aGUgdXNlciBleHBlcmllbmNlIGZvciBwb3N0aW5nIGEgbWVzc2FnZVxyXG5mdW5jdGlvbiBhd2FyZEV4cGVyaWVuY2UoY2xpZW50LCBtZXNzYWdlKSB7XHJcbiAgbGV0IHVzZXJuYW1lID0gcnNyYy5nZXRVc2VybmFtZUZyb21NZXNzYWdlKG1lc3NhZ2UpO1xyXG5cclxuICAvL2dldCB0aGUgY29udGVudCBmcm9tIHRoZSBzZXNzaW9uIGluc3RlYWQgb2YgZnJvbSB0aGUgZmlsZVxyXG4gIGxldCBjb250ZW50ID0gY2xpZW50LmdldFVzZXJDb250ZW50KG1lc3NhZ2UuZ3VpbGQsIHVzZXJuYW1lKTtcclxuXHJcbiAgaWYgKCFjb250ZW50KSB7XHJcbiAgICByZXR1cm4gY29uc29sZS5lcnJvcihgISEgQ291bGQgbm90IHJldHJpZXZlIGNvbnRlbnRzIGZyb20gWyR7dXNlcm5hbWV9XWApO1xyXG4gIH1cclxuXHJcbiAgY29udGVudC5yYW5rLnhwICs9IDE7XHJcblxyXG4gIGlmIChjb250ZW50LnJhbmsueHAgPj0gY29udGVudC5yYW5rLmxldmVsdXApIHtcclxuICAgIGNvbnRlbnQucmFuay5sZXZlbCArPSAxO1xyXG5cclxuICAgIHZhciByYW5rID0gcmFua3MubGV2ZWxzW2NvbnRlbnQucmFuay5sZXZlbF07XHJcbiAgICBpZiAocmFuaykge1xyXG4gICAgICB2YXIgbGFzdFJhbmsgPSBjb250ZW50LnJhbmsubmFtZTtcclxuXHJcbiAgICAgIGNvbnRlbnQucmFuay5uYW1lID0gcmFuaztcclxuICAgICAgbGV0IG9sZFJvbGUgPSBtZXNzYWdlLmd1aWxkLnJvbGVzLmZpbmQocm9sZSA9PiByb2xlLm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbGFzdFJhbmsudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgIGxldCBuZXdSb2xlID0gbWVzc2FnZS5ndWlsZC5yb2xlcy5maW5kKHJvbGUgPT4gcm9sZS5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IHJhbmsudG9Mb3dlckNhc2UoKSk7XHJcblxyXG4gICAgICBpZiAob2xkUm9sZSlcclxuICAgICAgICBtZXNzYWdlLm1lbWJlci5yZW1vdmVSb2xlKG9sZFJvbGUpLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgbWVzc2FnZS5tZW1iZXIuYWRkUm9sZShuZXdSb2xlKS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnRlbnQucmFuay5sZXZlbHVwID0gcnNyYy5nZXRYUFRvTGV2ZWxVcChjb250ZW50LnJhbmsueHAsIGNvbnRlbnQucmFuay5sZXZlbCk7XHJcbiAgICBsZXZlbFVwKGNsaWVudCwgbWVzc2FnZSwgY29udGVudCk7XHJcbiAgfVxyXG5cclxuICBjbGllbnQudXBkYXRlVXNlcihjb250ZW50KTtcclxuXHJcbiAgLy9vbmx5IHdyaXRlIFhQIGNoYW5nZXMgdG8gdGhlIGZpbGUgZXZlcnkgMTAgbWVzc2FnZXNcclxuICBpZiAoY29udGVudC5yYW5rLnhwICUgY2xpZW50Lmdsb2JhbF9jb25maWcucHJlZmVyZW5jZXMueHBfdGhyZXNob2xkID09PSAwKSB7XHJcbiAgICBsZXQganNvbkZpbGUgPSBwYXRoLmpvaW4ocnNyYy5nZXRVc2VyRGlyZWN0b3J5RnJvbUd1aWxkKG1lc3NhZ2UuZ3VpbGQsIHVzZXJuYW1lKSwgdXNlcm5hbWUgKyBcIi5qc29uXCIpO1xyXG4gICAgbGV0IG5ld0pzb24gPSBKU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCBcIlxcdFwiKTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMoanNvbkZpbGUsIG5ld0pzb24pO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gbGV2ZWxVcChjbGllbnQsIG1lc3NhZ2UsIGNvbnRlbnQpIHtcclxuICB2YXIgc3RhdHMgPSBjbGllbnQuY29tbWFuZHMuZ2V0KFwic3RhdHNcIik7XHJcbiAgbGV0IGVtYmVkID0gc3RhdHMuZ2V0RW1iZWQoY2xpZW50LCBtZXNzYWdlLm1lbWJlciwgY29udGVudCk7XHJcblxyXG4gIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGBDb25ncmF0dWxhdGlvbnMgJHttZXNzYWdlLmF1dGhvcn0hICBZb3UganVzdCBsZXZlbGVkIHVwISAgS2VlcCBjaGF0dGluZyB0byBlYXJuIG1vcmUgWFAgYW5kIHVubG9jayByb2xlcyBhbmQgc3BlY2lhbCBwZXJrcyFgKTtcclxuICBtZXNzYWdlLmNoYW5uZWwuc2VuZChlbWJlZCk7XHJcbn1cclxuIl19